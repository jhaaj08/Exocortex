{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Exocortex - AI-Powered Learning{% endblock %}</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <meta name="theme-color" content="#0d6efd">
    <meta name="description" content="Transform PDFs into AI-powered 7-minute focus blocks for accelerated learning.">
    
    <!-- iOS PWA Meta Tags -->
    <link rel="apple-touch-icon" href="{% static 'icons/icon-192.png' %}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Exocortex">
    
    <!-- Android PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Exocortex">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    {% block extra_css %}{% endblock %}
    
    <style>
        /* PWA Install Button Styles */
        #pwa-install-banner {
            background: linear-gradient(135deg, #0d6efd, #6610f2);
            border: none;
            color: white;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            border-radius: 50px;
            padding: 12px 20px;
            box-shadow: 0 4px 20px rgba(13, 110, 253, 0.3);
            animation: pulse 2s infinite;
        }
        
        #pwa-install-banner:hover {
            background: linear-gradient(135deg, #0b5ed7, #5a0dad);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(13, 110, 253, 0.4);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Improved offline indicator - non-blocking */
        .offline-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #fd7e14, #dc3545);
            color: white;
            text-align: center;
            padding: 8px 16px;
            border-radius: 25px;
            z-index: 1000;
            display: none;
            font-size: 0.875rem;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
            transition: all 0.3s ease;
            max-width: 200px;
            backdrop-filter: blur(10px);
        }
        
        .offline-indicator.minimized {
            padding: 6px 12px;
            font-size: 0.75rem;
            background: rgba(220, 53, 69, 0.8);
            opacity: 0.8;
        }
        
        .offline-indicator .close-btn {
            margin-left: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            opacity: 0.7;
        }
        
        .offline-indicator .close-btn:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Improved Offline Indicator -->
    <div id="offline-indicator" class="offline-indicator">
        <i class="fas fa-wifi-slash me-2"></i>
        <span class="offline-text">Offline Mode</span>
        <button class="close-btn" onclick="minimizeOfflineIndicator()" title="Minimize">×</button>
    </div>

    <!-- PWA Install Banner -->
    <button id="pwa-install-banner" style="display: none;" onclick="installPWA()">
        <i class="fas fa-download me-2"></i>Install App
    </button>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow">
        <div class="container-fluid">
            <!-- Brand -->
            <a class="navbar-brand fw-bold" href="{% url 'flashcards:home' %}">
                <i class="fas fa-brain me-2"></i>Exocortex
                <small class="fs-6 opacity-75 ms-2">AI Learning</small>
            </a>
            
            <!-- Mobile toggle -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <!-- Navigation Links -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}" 
                           href="{% url 'flashcards:home' %}">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'upload' %}active{% endif %}" 
                           href="{% url 'flashcards:upload' %}">
                            <i class="fas fa-upload me-1"></i>Upload
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if 'focus' in request.resolver_match.url_name %}active{% endif %}" 
                           href="{% url 'flashcards:all_focus_blocks' %}">
                            <i class="fas fa-target me-1"></i>Focus Blocks
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'offline_study' %}active{% endif %}" 
                           href="{% url 'flashcards:offline_study' %}">
                            <i class="fas fa-download me-1"></i>Offline Study
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'flashcards:new_format_knowledge_graph' %}">
                            <i class="fas fa-project-diagram me-1"></i>Knowledge Graph
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>Account
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="{% url 'flashcards:focus_schedule' %}">
                                    <i class="fas fa-calendar-alt me-2"></i>Focus Schedule
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/admin/"><i class="fas fa-cog me-2"></i>Admin</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Messages -->
    {% if messages %}
        <div class="container-fluid mt-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {% if message.tags == 'error' %}
                        <i class="fas fa-exclamation-triangle me-2"></i>
                    {% elif message.tags == 'success' %}
                        <i class="fas fa-check-circle me-2"></i>
                    {% elif message.tags == 'warning' %}
                        <i class="fas fa-exclamation-circle me-2"></i>
                    {% else %}
                        <i class="fas fa-info-circle me-2"></i>
                    {% endif %}
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Main Content -->
    <main role="main">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-light text-center py-3 mt-5">
        <div class="container">
            <small class="text-muted">
                <i class="fas fa-brain me-1"></i>
                Exocortex - Transform PDFs into AI-powered learning experiences
            </small>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- PWA Scripts -->
    <script>
        // Service Worker Registration - Enhanced Offline Support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    // Unregister any existing service workers first
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(registrations.map(reg => reg.unregister()));
                    
                    // Register the enhanced service worker
                    const registration = await navigator.serviceWorker.register('/sw.js', {
                        scope: '/'
                    });
                    
                    console.log('✅ Enhanced SW registered:', registration.scope);
                    
                    // Force update if new version available
                    if (registration.waiting) {
                        registration.waiting.postMessage({type: 'SKIP_WAITING'});
                    }
                    
                    // Handle updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed') {
                                console.log('🔄 New service worker available');
                            }
                        });
                    });
                    
                } catch (error) {
                    console.error('❌ SW registration failed:', error);
                }
            });
        }

        // PWA Install Prompt - Updated for iOS support
        let deferredPrompt;
        const installButton = document.getElementById('pwa-install-banner');

        // Check if user is on iOS
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        // Check if PWA is already installed on iOS
        function isStandalone() {
            return window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
        }

        // Android/Desktop install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'block';
        });

        // iOS install prompt
        function showIOSInstallPrompt() {
            if (isIOS() && !isStandalone()) {
                // Show iOS-specific install banner
                installButton.innerHTML = '<i class="fas fa-share me-2"></i>Tap Share → Add to Home Screen';
                installButton.style.display = 'block';
                installButton.onclick = function() {
                    alert('To install this app on your iPhone:\n\n1. Tap the Share button (⬆️) at the bottom of Safari\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add" to install');
                };
            }
        }

        function installPWA() {
            if (deferredPrompt) {
                // Android/Desktop
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                        installButton.style.display = 'none';
                    }
                    deferredPrompt = null;
                });
            } else if (isIOS()) {
                // iOS fallback
                alert('To install this app on your iPhone:\n\n1. Tap the Share button (⬆️) at the bottom of Safari\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add" to install');
            }
        }

        // Hide install button if already installed
        window.addEventListener('appinstalled', () => {
            installButton.style.display = 'none';
            console.log('PWA was installed');
        });

        // Check for iOS on page load
        document.addEventListener('DOMContentLoaded', function() {
            showIOSInstallPrompt();
        });

        // Online/Offline Detection
        const offlineIndicator = document.getElementById('offline-indicator');
        
        function updateOnlineStatus() {
            if (navigator.onLine) {
                offlineIndicator.style.display = 'none';
            } else {
                offlineIndicator.style.display = 'block';
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus(); // Check initial state

        // Update service worker
        navigator.serviceWorker?.ready.then((registration) => {
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker?.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        // New version available
                        if (confirm('New version available! Reload to update?')) {
                            window.location.reload();
                        }
                    }
                });
            });
        });
    </script>

    <!-- Offline Detection and Smart Routing -->
    <script>
        // Add offline detection and smart routing
        function updateOfflineNavigation() {
            if (!navigator.onLine) {
                // If offline, redirect study plan links to offline version
                const studyPlanLinks = document.querySelectorAll('a[href="/focus-blocks/"]');
                studyPlanLinks.forEach(link => {
                    link.href = '/offline-plan/';
                    link.title = 'Study Plan (Offline Mode)';
                    // Add offline indicator
                    if (!link.querySelector('.offline-indicator')) {
                        const indicator = document.createElement('i');
                        indicator.className = 'fas fa-wifi-slash text-warning ms-1 offline-indicator';
                        indicator.style.fontSize = '0.8em';
                        link.appendChild(indicator);
                    }
                });
                
                // Add offline badge to navbar
                addOfflineBadge();
            } else {
                // Restore original links when online
                const studyPlanLinks = document.querySelectorAll('a[href="/offline-plan/"]');
                studyPlanLinks.forEach(link => {
                    link.href = '/focus-blocks/';
                    link.title = 'Study Plan';
                    // Remove offline indicator
                    const indicator = link.querySelector('.offline-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                });
                
                // Remove offline badge
                removeOfflineBadge();
            }
        }
        
        function addOfflineBadge() {
            if (document.querySelector('.navbar-offline-badge')) return;
            
            const navbar = document.querySelector('.navbar-nav');
            if (navbar) {
                const badge = document.createElement('li');
                badge.className = 'nav-item navbar-offline-badge';
                badge.innerHTML = `
                    <span class="nav-link">
                        <span class="badge bg-warning">
                            <i class="fas fa-wifi-slash me-1"></i>Offline
                        </span>
                    </span>
                `;
                navbar.appendChild(badge);
            }
        }
        
        function removeOfflineBadge() {
            const badge = document.querySelector('.navbar-offline-badge');
            if (badge) {
                badge.remove();
            }
        }
        
        // Improved offline indicator management
        let offlineIndicatorMinimized = localStorage.getItem('offline_indicator_minimized') === 'true';
        
        function updateOfflineIndicator() {
            const indicator = document.getElementById('offline-indicator');
            const text = document.querySelector('.offline-text');
            
            if (!navigator.onLine) {
                indicator.style.display = 'block';
                
                if (offlineIndicatorMinimized) {
                    indicator.classList.add('minimized');
                    text.textContent = '📱';
                } else {
                    indicator.classList.remove('minimized');
                    text.textContent = 'Offline Mode';
                }
            } else {
                indicator.style.display = 'none';
            }
        }
        
        function minimizeOfflineIndicator() {
            const indicator = document.getElementById('offline-indicator');
            offlineIndicatorMinimized = !offlineIndicatorMinimized;
            
            localStorage.setItem('offline_indicator_minimized', offlineIndicatorMinimized);
            updateOfflineIndicator();
        }
        
        // Listen for connectivity changes
        window.addEventListener('online', function() {
            updateOfflineIndicator();
            updateOfflineNavigation();
        });
        
        window.addEventListener('offline', function() {
            updateOfflineIndicator();
            updateOfflineNavigation();
        });
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateOfflineIndicator();
            updateOfflineNavigation();
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html> 
<script>
// Enhanced offline support for seamless experience
class OfflineManager {
    constructor() {
        this.init();
    }

    init() {
        // Register service worker if not already registered
        if ('serviceWorker' in navigator) {
            this.setupServiceWorkerMessageListener();
        }

        // Monitor connection changes
        window.addEventListener('online', () => {
            this.handleOnline();
        });

        window.addEventListener('offline', () => {
            this.handleOffline();
        });

        // Cache study data for offline use
        this.cacheStudyData();
    }

    async setupServiceWorkerMessageListener() {
        // Listen for messages from service worker (registration handled globally above)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data.type === 'SYNC_OFFLINE_PROGRESS') {
                    this.syncOfflineProgress();
                }
            });
        }
    }

    handleOnline() {
        console.log('🌐 Back online');
        
        // Update connection indicators
        document.querySelectorAll('.offline-indicator').forEach(el => {
            el.style.display = 'none';
        });

        // Auto-sync offline progress
        setTimeout(() => {
            this.syncOfflineProgress();
        }, 2000);

        // Show online notification
        this.showNotification('Back online! Syncing your progress...', 'success');
    }

    handleOffline() {
        console.log('�� Gone offline');
        
        // Update connection indicators
        document.querySelectorAll('.offline-indicator').forEach(el => {
            el.style.display = 'block';
        });

        // Show offline notification
        this.showNotification('You\'re offline. Cached data available for study.', 'info');
    }

    async cacheStudyData() {
        // Cache current page data for offline use
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            const studyData = this.extractStudyData();
            
            navigator.serviceWorker.controller.postMessage({
                type: 'CACHE_STUDY_DATA',
                data: studyData
            });
        }
    }

    extractStudyData() {
        // Extract study data from current page
        const data = {
            timestamp: new Date().toISOString(),
            page: window.location.pathname,
            studyPlans: {}
        };

        // Extract study plan data if on home page
        if (window.location.pathname === '/' || window.location.pathname === '/home/') {
            const planElements = document.querySelectorAll('[data-plan-type]');
            planElements.forEach(el => {
                const planType = el.getAttribute('data-plan-type');
                const planData = {
                    type: planType,
                    blocks: el.getAttribute('data-blocks') || '0',
                    duration: el.getAttribute('data-duration') || '0'
                };
                data.studyPlans[planType] = planData;
            });
        }

        return data;
    }

    async syncOfflineProgress() {
        if (!navigator.onLine) {
            console.log('Still offline, cannot sync');
            return;
        }

        try {
            const offlineProgress = localStorage.getItem('offlineProgress');
            if (!offlineProgress) {
                return;
            }

            const progressData = JSON.parse(offlineProgress);
            if (!progressData.completed_blocks || progressData.completed_blocks.length === 0) {
                return;
            }

            console.log('🔄 Syncing offline progress...');

            const response = await fetch('/api/sync-offline-enhanced/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    offline_progress: progressData,
                    last_sync_timestamp: localStorage.getItem('lastSync')
                })
            });

            const result = await response.json();

            if (result.success) {
                // Clear synced progress
                progressData.completed_blocks = [];
                localStorage.setItem('offlineProgress', JSON.stringify(progressData));
                localStorage.setItem('lastSync', result.sync_timestamp);

                this.showNotification(`✅ Synced ${result.synced_blocks} completed blocks`, 'success');
                
                // Refresh page to show updated data
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }

        } catch (error) {
            console.error('Failed to sync offline progress:', error);
        }
    }

    showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(notification);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    getCSRFToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]');
        return token ? token.value : '';
    }
}

// Initialize offline manager when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    window.offlineManager = new OfflineManager();
});
</script>

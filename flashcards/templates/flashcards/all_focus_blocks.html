{% extends 'flashcards/base.html' %}

{% block title %}Advanced Study - Exocortex{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- ✅ ADD: Hidden session data -->
    <div id="session-data" 
         data-session-id="{{ study_session.id|default:'' }}" 
         style="display: none;"></div>
    
    {% if no_blocks %}
    <!-- No Focus Blocks State -->
    <div class="row justify-content-center">
        <div class="col-md-8 text-center py-5">
            <i class="fas fa-target fa-4x text-muted mb-4"></i>
            <h3 class="text-muted">No Focus Blocks Yet</h3>
            <p class="text-muted mb-4">Upload PDFs to generate AI-powered focus blocks</p>
            <a href="{% url 'flashcards:home' %}" class="btn btn-primary btn-lg">
                <i class="fas fa-upload me-2"></i>Upload Your First PDF
            </a>
        </div>
    </div>
    
    {% else %}
    
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-1">
                                <i class="fas fa-brain me-2"></i>Advanced Study Session
                            </h3>
                            <p class="mb-0">
                                <i class="fas fa-layer-group me-1"></i>{{ total_blocks }} Focus Blocks
                                <span class="badge bg-light text-primary ms-2">{{ total_study_time|floatformat:0 }}min total</span>
                            </p>
                        </div>
                    </div>
                </div>
                <!-- Enhanced Progress Bar -->
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-success" id="main-progress" 
                         style="width: {{ progress_percentage }}%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Study Content -->
        <div class="col-lg-8">
            {% for block_data in focus_blocks %}
            <!-- Learning Objectives -->
            {% if block_data.learning_objectives %}
            <div class="card mb-4" id="block-{{ forloop.counter0 }}" style="{% if not forloop.first %}display: none;{% endif %}">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-bullseye me-2"></i>Learning Objectives</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        {% for objective in block_data.learning_objectives %}
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>{{ objective }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Interactive Learning Segments -->
            <div class="card mb-4" id="segments-{{ forloop.counter0 }}" style="{% if not forloop.first %}display: none;{% endif %}">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chalkboard-teacher me-2"></i>{{ block_data.block.title }}</h5>
                    <div class="block-navigation">
                        <span class="badge bg-light text-dark me-2">
                            Block <span id="current-block">{{ forloop.counter }}</span> of {{ focus_blocks|length }}
                        </span>
        </div>
                </div>
                <div class="card-body">
                    {% for segment in block_data.segments %}
                    <div class="segment-container mb-4 p-3 border rounded" 
                         id="segment-{{ forloop.parentloop.counter0 }}-{{ forloop.counter0 }}" 
                         data-segment-index="{{ forloop.counter0 }}"
                         data-block-index="{{ forloop.parentloop.counter0 }}"
                         style="{% if not forloop.first %}display: none;{% endif %}">
                        
                        <div class="segment-header d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-primary mb-0">
                                <span class="badge bg-primary me-2">{{ forloop.counter }}</span>
                                {{ segment.type|default:"Learning Segment"|title }}
                            </h6>
                            <div>
                                <span class="badge bg-secondary">{{ segment.time_sec|default:60 }}s</span>
                                <button class="btn btn-sm btn-outline-success ms-2" 
                                        onclick="markSegmentComplete({{ forloop.parentloop.counter0 }}, {{ forloop.counter0 }})">
                                    <i class="fas fa-check"></i> Complete
                                </button>
                            </div>
                        </div>
                        
                        <!-- Segment Content -->
                        {% if segment.content %}
                        <div class="content-section mb-3">
                            <div class="p-3 bg-light rounded border-start border-4 border-primary">
                                {{ segment.content|linebreaks }}
                            </div>
                        </div>
                        {% endif %}

                        {% if segment.explanation %}
                        <div class="explanation-section mb-3">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-lightbulb text-warning"></i> Key Insight:</h6>
                                {{ segment.explanation|linebreaks }}
                    </div>
                </div>
                                        {% endif %}

                        {% if segment.examples %}
                        <div class="examples-section mb-3">
                            <h6><i class="fas fa-list-alt text-success"></i> Examples:</h6>
                            <div class="row">
                                {% for example in segment.examples %}
                                <div class="col-md-6 mb-2">
                                    <div class="card border-success">
                                        <div class="card-body p-2">
                                            <small>{{ example }}</small>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                                    </div>
                                    {% endif %}
                                    
                        <!-- Segment Notes -->
                        <div class="segment-notes mt-3">
                            <label class="form-label small text-muted">
                                <i class="fas fa-sticky-note"></i> Your notes for this segment:
                            </label>
                            <textarea class="form-control" 
                                      placeholder="Quick notes, questions, or insights..."
                                      data-block="{{ forloop.parentloop.counter0 }}"
                                      data-segment="{{ forloop.counter0 }}"
                                      onchange="saveSegmentNote({{ forloop.parentloop.counter0 }}, {{ forloop.counter0 }}, this.value)"></textarea>
                                            </div>
                                        </div>
                    {% endfor %}
                    
                    <!-- Navigation Controls -->
                    <div class="segment-navigation-controls d-flex justify-content-between align-items-center mt-4">
                        <button class="btn btn-outline-secondary" id="prev-btn-{{ forloop.counter0 }}" onclick="previousSegment({{ forloop.counter0 }})" disabled>
                            <i class="fas fa-chevron-left me-2"></i>Previous
                        </button>
                        
                        <!-- Simple Progress Bar -->
                        <div class="segment-progress">
                            <div class="progress" style="width: 200px; height: 8px;">
                                <div class="progress-bar bg-success" id="segment-progress-bar-{{ forloop.counter0 }}" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    
                        <button class="btn btn-primary" id="next-btn-{{ forloop.counter0 }}" onclick="nextSegment({{ forloop.counter0 }})">
                            Next<i class="fas fa-chevron-right ms-2"></i>
                        </button>
                                                </div>
                                            </div>
                                        </div>

            <!-- Q&A Section -->
            {% if block_data.qa_items %}
            <div class="card mb-4" id="qa-{{ forloop.counter0 }}" style="{% if not forloop.first %}display: none;{% endif %}">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i>Knowledge Check</h5>
                                    </div>
                <div class="card-body">
                    {% for qa_item in block_data.qa_items %}
                    <div class="qa-section mb-4 p-3 border rounded">
                        <div class="question-header mb-3">
                            <h6 class="text-primary">Question {{ forloop.counter }}:</h6>
                            <p class="fs-5">{{ qa_item.question }}</p>
                                        </div>
                                        
                        <div class="qa-actions text-center mb-3">
                            <button class="btn btn-outline-primary" 
                                    onclick="revealAnswer('qa{{ forloop.parentloop.counter0 }}_{{ forloop.counter }}')">
                                <i class="fas fa-eye me-1"></i>Show Answer
                                            </button>
                                        </div>
                                        
                        <div class="answer-section" id="qa{{ forloop.parentloop.counter0 }}_{{ forloop.counter }}" style="display: none;">
                            <div class="alert alert-success">
                                <h6><i class="fas fa-check-circle"></i> Answer:</h6>
                                {{ qa_item.answer|linebreaks }}
                                    </div>
                                    
                            <!-- Understanding Check -->
                            <div class="understanding-check mt-3">
                                <p class="small text-muted mb-2">How well did you understand this?</p>
                                <div class="btn-group btn-group-sm" role="group">
                                    {% for i in "12345" %}
                                    <input type="radio" class="btn-check" name="qa{{ forloop.parentloop.counter0 }}_{{ forloop.parentloop.counter }}_understanding" id="qa{{ forloop.parentloop.counter0 }}_{{ forloop.parentloop.counter }}_{{ i }}">
                                    <label class="btn btn-outline-primary" for="qa{{ forloop.parentloop.counter0 }}_{{ forloop.parentloop.counter }}_{{ i }}">{{ i }}</label>
                                            {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endfor %}
                </div>
                
        <!-- Study Sidebar -->
        <div class="col-lg-4">
            <!-- Study Progress -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-chart-line text-success"></i> Study Progress</h6>
                        </div>
                <div class="card-body">
                    <div class="progress-item mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>Overall Progress</small>
                            <small id="progress-text">{{ progress_percentage }}%</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" id="sidebar-progress" style="width: {{ progress_percentage }}%"></div>
                        </div>
                    </div>
                    
                    <div class="study-stats">
                        <div class="stat-item d-flex justify-content-between">
                            <span>Current Block:</span>
                            <span><span id="current-block-number">1</span>/{{ focus_blocks|length }}</span>
                        </div>
                        <div class="stat-item d-flex justify-content-between">
                            <span>Segments:</span>
                            <span><span id="completed-segments">0</span>/<span id="total-segments">{{ focus_blocks.0.total_segments }}</span></span>
                        </div>
                        <div class="stat-item d-flex justify-content-between">
                            <span>Q&A Items:</span>
                            <span id="current-qa-count">{{ focus_blocks.0.total_qa }}</span>
                        </div>
                        <div class="stat-item d-flex justify-content-between">
                            <span>Est. Time:</span>
                            <span id="current-duration">{{ focus_blocks.0.estimated_duration }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timer Card -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-clock text-warning"></i> Study Timer</h6>
                    <div class="timer-controls">
                        <button class="btn btn-sm btn-outline-warning" id="sidebar-pause-btn" onclick="togglePause()">
                            <i class="fas fa-pause" id="sidebar-pause-icon"></i>
                            <i class="fas fa-play d-none" id="sidebar-play-icon"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body text-center">
                    <div class="timer-display mb-3">
                        <div class="h4 text-primary mb-1" id="session-timer">00:00:00</div>
                        <small class="text-muted">Total Session Time</small>
                    </div>
                    <div class="timer-display">
                        <div class="h5 text-success mb-1" id="block-timer">00:00</div>
                        <small class="text-muted">Current Block</small>
        </div>
    </div>
            </div>

            <!-- Real-time Notes -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-edit text-primary"></i> Session Notes</h6>
                </div>
                <div class="card-body">
                    <textarea class="form-control" rows="6" id="session-notes" 
                              placeholder="General thoughts, connections, insights..."></textarea>
                    <div class="mt-2 text-end">
                        <small class="text-muted">Auto-saved</small>
                    </div>
            </div>
        </div>
    </div>
</div>
    
    {% endif %}
</div>

<script>
// === MINIMAL JAVASCRIPT - BASIC NAVIGATION ONLY ===

let currentBlockIndex = 0;
let currentSegmentIndex = 0;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Checking for auto-events...');
    
    // Monitor all click events
    document.addEventListener('click', function(event) {
        console.log('👆 Click detected on:', event.target.tagName, event.target.className, event.target.id);
    });
    
    // Monitor any timers
    const originalSetTimeout = window.setTimeout;
    window.setTimeout = function(fn, delay) {
        console.log('⏰ setTimeout called with delay:', delay);
        console.trace('setTimeout call stack:');
        return originalSetTimeout(fn, delay);
    };
    
    // Show first segment
    showSegment(0, 0);
});

// Show specific block
function showBlock(blockIndex) {
    console.log('📖 Showing block:', blockIndex);
    
    // Hide all blocks
    const allBlocks = document.querySelectorAll('.focus-block-container');
    allBlocks.forEach(block => block.style.display = 'none');
    
    // Show target block
    const targetBlock = allBlocks[blockIndex];
    if (targetBlock) {
        targetBlock.style.display = 'block';
        currentBlockIndex = blockIndex;
        currentSegmentIndex = 0;
        showSegment(blockIndex, 0);
    }
}

// Show specific segment
function showSegment(blockIndex, segmentIndex) {
    console.log('📝 === showSegment() called ===', blockIndex, segmentIndex);
    
    // Prevent runaway calls
    if (segmentIndex === currentSegmentIndex) {
        console.log('⚠️ Already showing this segment, skipping');
        return;
    }
    
    // Hide all segments in this block
    const allSegments = document.querySelectorAll(`[id^="segment-${blockIndex}-"]`);
    console.log('Found segments in block:', allSegments.length);
    
    allSegments.forEach(segment => {
        segment.style.display = 'none';
    });
    
    // Show target segment
    const targetSegment = document.getElementById(`segment-${blockIndex}-${segmentIndex}`);
    if (targetSegment) {
        targetSegment.style.display = 'block';
        currentSegmentIndex = segmentIndex;
        console.log('✅ Showing segment:', segmentIndex);
    } else {
        console.log('❌ Target segment not found:', `segment-${blockIndex}-${segmentIndex}`);
    }
    
    updateNavigationButtons();
    console.log('=== showSegment() finished ===');
}

let isProcessing = false;

function nextSegment() {
    console.log('🔄 === nextSegment() called ===');
    console.log('Current segment:', currentSegmentIndex);
    
    // Mark current segment complete first
    markSegmentComplete(currentBlockIndex, currentSegmentIndex);
    
    // Check if next segment exists in current block
    const nextSegmentIndex = currentSegmentIndex + 1;
    const nextSegmentEl = document.getElementById(`segment-${currentBlockIndex}-${nextSegmentIndex}`);
    
    console.log('Looking for:', `segment-${currentBlockIndex}-${nextSegmentIndex}`);
    console.log('Found next segment:', nextSegmentEl !== null);
    
    if (nextSegmentEl) {
        console.log('✅ Moving to next segment');
        showSegment(currentBlockIndex, nextSegmentIndex);
    } else {
        console.log('📝 End of segments in current block');
        // markSegmentComplete() will handle block advancement automatically
        // No need for manual alerts or reloads
    }
    
    console.log('=== nextSegment() finished ===');
}

function previousSegment() {
    if (currentSegmentIndex > 0) {
        showSegment(currentBlockIndex, currentSegmentIndex - 1);
    }
}

// Update navigation buttons
function updateNavigationButtons() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    if (prevBtn) prevBtn.disabled = (currentSegmentIndex === 0);
    if (nextBtn) {
        const nextSegmentExists = document.getElementById(`segment-${currentBlockIndex}-${currentSegmentIndex + 1}`);
        nextBtn.disabled = !nextSegmentExists;
    }
}

function updateProgressDisplay(progressPercent, completedSegments) {
    console.log('📊 Updating progress display:', progressPercent + '%', completedSegments, 'segments completed');
    
    // Update progress bar width
    const progressBar = document.getElementById('sidebar-progress');
    if (progressBar) {
        progressBar.style.width = progressPercent + '%';
        console.log('✅ Progress bar updated to', progressPercent + '%');
    } else {
        console.log('⚠️ Progress bar element not found (sidebar-progress)');
    }
    
    // Update progress percentage text
    const progressText = document.getElementById('progress-text');
    if (progressText) {
        progressText.textContent = Math.round(progressPercent) + '%';
        console.log('✅ Progress text updated to', Math.round(progressPercent) + '%');
    } else {
        console.log('⚠️ Progress text element not found (progress-text)');
    }
    
    // Update completed segments counter
    const completedEl = document.getElementById('completed-segments');
    if (completedEl) {
        completedEl.textContent = completedSegments;
        console.log('✅ Completed segments updated to', completedSegments);
    } else {
        console.log('⚠️ Completed segments element not found (completed-segments)');
    }
    
    // Optional: Update total segments if needed
    const totalSegmentsEl = document.getElementById('total-segments');
    if (totalSegmentsEl) {
        console.log('✅ Total segments element found:', totalSegmentsEl.textContent);
    } else {
        console.log('⚠️ Total segments element not found (total-segments)');
    }
    
    console.log('📊 Progress display update complete');
}

// Simple complete function (no AJAX)
function markSegmentComplete(blockIndex, segmentIndex) {
    console.log('✅ Marking segment complete:', blockIndex, segmentIndex);
    
    // Visual feedback first
    const segment = document.getElementById(`segment-${blockIndex}-${segmentIndex}`);
    if (segment) {
        segment.style.backgroundColor = '#d4edda';
        segment.style.border = '2px solid #155724';
    }
    
    // Get session ID
    const sessionId = document.getElementById('session-data')?.getAttribute('data-session-id');
    
    if (sessionId) {
        fetch('/mark-segment-complete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                session_id: sessionId,
                segment_index: segmentIndex
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('🔍 Django response:', data);
            
            if (data.success) {
                console.log('✅ Backend updated, progress:', data.progress + '%');
                updateProgressDisplay(data.progress, segmentIndex + 1);
                
                // ✅ CHECK: Did we advance to next block?
                if (data.advanced_to_next) {
                    console.log('🔄 Advanced to next block:', data.new_block_title);
                    console.log('🔄 Reloading page to show next block...');
                    
                    // Auto-reload to get next block
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000); // 1 second delay for visual feedback
                    
                } else if (data.all_completed) {
                    console.log('🎉 All blocks completed!');
                    alert('🎉 Congratulations! All focus blocks completed!');
                    
                } else {
                    console.log('📝 Continuing with current block');
                    // Normal advancement within same block - do nothing
                    // nextSegment() will be called separately
                }
                
            } else {
                console.error('❌ Backend error:', data.error);
                alert('Error updating progress: ' + data.error);
            }
        })
        .catch(error => {
            console.error('❌ Network error:', error);
            alert('Network error updating progress');
        });
    } else {
        console.error('❌ No session ID found');
    }
}

// Helper function for CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

console.log('✅ Minimal JavaScript loaded');
</script>

<style>
.segment-container {
    transition: all 0.3s ease;
}

.segment-container.border-success {
    background-color: #f8fff9 !important;
}

.timer-display {
    font-family: 'Courier New', monospace;
}

.stat-item {
    padding: 0.25rem 0;
    border-bottom: 1px solid #eee;
}

.stat-item:last-child {
    border-bottom: none;
}

.progress-item {
    margin-bottom: 1rem;
}
</style>
{% endblock %}

{% extends 'flashcards/base.html' %}

{% block title %}Focus Blocks - Exocortex{% endblock %}

{% block content %}
<div class="container-fluid">
    
    {% if no_blocks %}
    <!-- No Focus Blocks State -->
    <div class="row justify-content-center">
        <div class="col-md-8 text-center py-5">
            <i class="fas fa-target fa-4x text-muted mb-4"></i>
            <h3 class="text-muted">No Focus Blocks Yet</h3>
            <p class="text-muted mb-4">Upload PDFs on the home page to generate AI-powered focus blocks</p>
            <a href="{% url 'flashcards:home' %}" class="btn btn-primary btn-lg">
                <i class="fas fa-upload me-2"></i>Upload Your First PDF
            </a>
        </div>
    </div>
    
    {% else %}
    
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="text-center">
                <h1 class="display-5 mb-3">
                    <i class="fas fa-target me-3"></i>Focus Blocks
                </h1>
                <p class="lead text-muted">AI-powered micro-lessons for optimal learning</p>
            </div>
        </div>
    </div>

    <!-- Study Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center bg-primary text-white">
                <div class="card-body">
                    <i class="fas fa-layer-group fa-2x mb-2"></i>
                    <h4>{{ total_blocks }}</h4>
                    <p class="mb-0">Total Blocks</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h4>{{ total_study_time|floatformat:0 }}m</h4>
                    <p class="mb-0">Study Time</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <i class="fas fa-file-pdf fa-2x mb-2"></i>
                    <h4>{{ unique_pdfs }}</h4>
                    <p class="mb-0">Source PDFs</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-warning text-dark">
                <div class="card-body">
                    <i class="fas fa-brain fa-2x mb-2"></i>
                    <h4>6-7min</h4>
                    <p class="mb-0">Per Block</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified Study Interface -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-play-circle me-2"></i>Interactive Study Session
                        </h5>
                        
                        <!-- ADD GLOBAL TIMER SECTION -->
                        <div class="text-center">
                            <div id="global-timer" style="font-family: monospace; font-size: 1.3rem; font-weight: bold;">
                                üïê 00:00:00
                            </div>
                            <div class="mt-1">
                                <button class="btn btn-success btn-sm" id="global-start-btn" onclick="startGlobalTimer()">
                                    <i class="fas fa-play"></i> Start Session
                                </button>
                                <button class="btn btn-warning btn-sm" id="global-pause-btn" onclick="pauseGlobalTimer()" style="display: none;">
                                    <i class="fas fa-pause"></i> Pause
                                </button>
                                <button class="btn btn-danger btn-sm" id="global-stop-btn" onclick="stopGlobalTimer()" style="display: none;">
                                    <i class="fas fa-stop"></i> End Session
                                </button>
                                <!-- ADD THIS VIEW DATA BUTTON -->
                                <button class="btn btn-info btn-sm" onclick="viewCompletions()" title="View Progress">
                                    <i class="fas fa-chart-line"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- REPLACE line 107 with better block indicator: -->
                        <div class="d-flex align-items-center">
                            <span class="badge bg-primary me-2" id="blockIndicator">Block 1</span>
                            <span class="badge bg-warning" id="currentDuration">6-7 min</span>
                            <small class="text-muted ms-2" id="blockProgress">Step 1 of 5</small>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-success" id="overallProgress" style="width: 0%"></div>
                </div>
                
                <div class="card-body">
                    <!-- Block Content Container -->
                    <div id="blockContent">
                        
                        {% for block_data in formatted_blocks %}
                        <div class="focus-block-container" 
                             data-block-index="{{ forloop.counter0 }}" 
                             data-focus-block-id="{{ block_data.block.id }}" 
                             style="display: none;">
                            
                            <!-- Block Header -->
                            <div class="block-header mb-4 p-3 bg-light rounded">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h3 class="mb-1">{{ block_data.block.title }}</h3>
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-file-pdf me-1"></i>{{ block_data.source_pdf }}
                                        </p>
                                        {% if block_data.block.get_core_goal %}
                                        <p class="text-primary mb-0">
                                            <i class="fas fa-bullseye me-1"></i>{{ block_data.block.get_core_goal }}
                                        </p>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <div class="mb-2">
                                            <span class="badge bg-primary me-1">{{ block_data.total_segments }} segments</span>
                                            <span class="badge bg-warning">{{ block_data.total_qa }} Q&A</span>
                                        </div>
                                        <div class="mb-2">
                                            <span class="badge bg-info">{{ block_data.block.get_estimated_duration_display }}</span>
                                        </div>
                                        
                                        <!-- REPLACE the timer section you added with this: -->
                                        <div class="mb-2">
                                            <div class="text-center">
                                                <small class="text-muted">Block Timer</small>
                                                <div id="timer-{{ forloop.counter0 }}" style="font-family: monospace; font-size: 1.0rem; color: #28a745; font-weight: bold;">
                                                    ‚è±Ô∏è 00:00:00
                                                </div>
                                                <small class="text-muted">Auto</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step Content for this Block -->
                            <div class="step-content">
                                
                                <!-- Revision Step -->
                                {% if block_data.revision_data %}
                                <div class="study-step" style="display: none;">
                                    <div class="step-header mb-3">
                                        <h4><i class="fas fa-redo text-secondary me-2"></i>Quick Revision</h4>
                                    </div>
                                    
                                    {% if block_data.revision_data.nano_recap %}
                                    <div class="revision-content bg-light p-4 rounded mb-3">
                                        <h6>Context Reminder:</h6>
                                        <p class="mb-0">{{ block_data.revision_data.nano_recap }}</p>
                                    </div>
                                    {% endif %}
                                    
                                    {% if block_data.revision_data.question %}
                                    <div class="revision-question border-start border-primary border-4 ps-3">
                                        <h6>Quick Check:</h6>
                                        <p><strong>{{ block_data.revision_data.question.prompt }}</strong></p>
                                        <div class="mt-2">
                                            <button class="btn btn-sm btn-outline-primary" onclick="toggleAnswer('revision{{ forloop.counter0 }}')">
                                                <i class="fas fa-eye me-1"></i>Show Answer
                                            </button>
                                            <div id="revision{{ forloop.counter0 }}" class="mt-2 text-success" style="display: none;">
                                                <strong>Answer:</strong> {{ block_data.revision_data.question.answer }}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <!-- Teaching Segments -->
                                {% for segment in block_data.segments %}
                                <div class="study-step" style="display: none;">
                                    <div class="step-header mb-3">
                                        <h4><i class="fas fa-chalkboard-teacher text-success me-2"></i>{{ segment.title }}</h4>
                                        <div class="d-flex justify-content-between">
                                            <p class="text-muted mb-0">Segment {{ forloop.counter }}</p>
                                            <span class="badge bg-primary">{{ segment.time_sec }}s</span>
                                        </div>
                                    </div>
                                    
                                    {% if segment.teach %}
                                    <div class="teaching-content">
                                        {% for step in segment.teach %}
                                        <div class="teaching-step mb-3 p-3 rounded border-start border-4 
                                             {% if step.mode == 'socratic' %}border-info bg-light-blue
                                             {% elif step.mode == 'example' %}border-success bg-light-green
                                             {% elif step.mode == 'warning' %}border-warning bg-light-warning
                                             {% else %}border-secondary bg-light{% endif %}">
                                            
                                            <div class="d-flex align-items-start">
                                                <span class="badge 
                                                      {% if step.mode == 'socratic' %}bg-info
                                                      {% elif step.mode == 'example' %}bg-success
                                                      {% elif step.mode == 'warning' %}bg-warning
                                                      {% else %}bg-secondary{% endif %} me-3">
                                                    {{ step.mode|title }}
                                                </span>
                                                <div class="flex-grow-1">
                                                    <p class="mb-0">{{ step.text }}</p>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}

                                <!-- Q&A Steps -->
                                {% for qa in block_data.qa_items %}
                                <div class="study-step" style="display: none;">
                                    <div class="step-header mb-3">
                                        <h4><i class="fas fa-question-circle text-warning me-2"></i>Knowledge Check {{ forloop.counter }}</h4>
                                    </div>
                                    
                                    <div class="qa-interactive">
                                        <div class="question-card bg-primary text-white p-4 rounded mb-3">
                                            <h5>{{ qa.prompt }}</h5>
                                            <span class="badge bg-light text-primary">{{ qa.type|title }} Question</span>
                                        </div>
                                        
                                        <div class="text-center mb-3">
                                            <button class="btn btn-success btn-lg" onclick="revealAnswer('qa{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}')">
                                                <i class="fas fa-eye me-2"></i>Reveal Answer
                                            </button>
                                        </div>
                                        
                                        <div id="qa{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" class="answer-section" style="display: none;">
                                            <div class="answer-card bg-success text-white p-4 rounded mb-3">
                                                <h6><i class="fas fa-check-circle me-2"></i>Ideal Answer:</h6>
                                                <p class="mb-0">{{ qa.ideal_answer }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}

                                <!-- Recap Step -->
                                {% if block_data.recap_data %}
                                <div class="study-step" style="display: none;">
                                    <div class="step-header mb-3">
                                        <h4><i class="fas fa-flag-checkered text-success me-2"></i>Block Complete!</h4>
                                    </div>
                                    
                                    {% if block_data.recap_data.bullets %}
                                    <div class="recap-content bg-success text-white p-4 rounded mb-4">
                                        <h5><i class="fas fa-check-circle me-2"></i>Key Takeaways:</h5>
                                        <ul class="mb-0">
                                            {% for bullet in block_data.recap_data.bullets %}
                                            <li>{{ bullet }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}

                            </div>
                        </div>
                        {% endfor %}

                    </div>
                </div>
                
                <!-- Navigation Footer -->
                <div class="card-footer bg-light">
                    <!-- Mobile-friendly navigation -->
                    <div class="row align-items-center">
                        <div class="col-3">
                            <button class="btn btn-outline-secondary btn-lg w-100" id="prevBtn" onclick="previousStep()" disabled>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        </div>
                        <div class="col-6 text-center">
                            <!-- Visual progress for current block -->
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar" id="blockProgressBar" style="width: 20%"></div>
                            </div>
                            <small class="text-muted" id="stepInfo">Revision ‚Ä¢ 1/5</small>
                        </div>
                        <div class="col-3">
                            <button class="btn btn-primary btn-lg w-100" id="nextBtn" onclick="nextStep()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Swipe hint -->
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            <i class="fas fa-hand-point-right me-1"></i>Swipe or tap to navigate
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ADD THIS COMPLETION MODAL before the closing container div -->

<!-- Focus Block Completion Modal -->
<div class="modal fade" id="completionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Focus Block Complete!
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <h6>Block: <span id="completed-block-title"></span></h6>
                    <p class="text-muted">Time: <span id="completed-block-time"></span></p>
                </div>
                
                <div class="mb-4">
                    <label class="form-label h6">How well did you understand this content?</label>
                    <div class="rating-scale d-flex justify-content-center gap-2 mt-2">
                        <input type="radio" class="btn-check" name="proficiency" id="prof1" value="1">
                        <label class="btn btn-outline-danger" for="prof1">1<br><small>Poor</small></label>
                        
                        <input type="radio" class="btn-check" name="proficiency" id="prof2" value="2">
                        <label class="btn btn-outline-warning" for="prof2">2<br><small>Basic</small></label>
                        
                        <input type="radio" class="btn-check" name="proficiency" id="prof3" value="3">
                        <label class="btn btn-outline-info" for="prof3">3<br><small>Good</small></label>
                        
                        <input type="radio" class="btn-check" name="proficiency" id="prof4" value="4">
                        <label class="btn btn-outline-primary" for="prof4">4<br><small>Strong</small></label>
                        
                        <input type="radio" class="btn-check" name="proficiency" id="prof5" value="5">
                        <label class="btn btn-outline-success" for="prof5">5<br><small>Mastered</small></label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveCompletion()" id="save-completion-btn" disabled>
                    <i class="fas fa-save me-2"></i>Save & Continue
                </button>
            </div>
        </div>
    </div>
</div>
    
    {% endif %}
</div>

<script>
    // ‚úÖ Pass completion data from Django to JavaScript
    window.serverCompletions = {{ completion_data_json|safe }};
    console.log('üìä Server completion data loaded:', window.serverCompletions);
</script>

<script>
console.log('üß™ BASIC TEST: JavaScript is loading...');

// Simple test function
function testSync() {
    console.log('üß™ TEST: Function can run');
    
    fetch('/api/focus-completions/')
    .then(response => response.json())
    .then(data => {
        console.log('üß™ TEST: API response:', data);
        if (data.success && data.completions.length > 0) {
            console.log(`üß™ TEST: Found ${data.completions.length} completions`);
            // alert(`Found ${data.completions.length} completions in database!`); // REMOVED
        } else {
            console.log('üß™ TEST: No completions found');
        }
    })
    .catch(error => {
        console.log('üß™ TEST: API error:', error);
    });
}

// Run test immediately
console.log('üß™ RUNNING TEST...');
testSync();

// Also run test when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('üß™ DOM LOADED - running test again...');
    testSync();
});
</script>

<script>
// Global variables
let currentBlockIndex = 0;
let currentStepIndex = 0;
let totalBlocks = {{ total_blocks }};
let allSteps = [];
let blockContainers = [];

// Initialize the unified study interface
function initializeUnifiedStudy() {
    blockContainers = document.querySelectorAll('.focus-block-container');
    
    // Collect all steps from all blocks
    blockContainers.forEach((container, blockIndex) => {
        const steps = container.querySelectorAll('.study-step');
        steps.forEach((step, stepIndex) => {
            allSteps.push({
                blockIndex: blockIndex,
                stepIndex: stepIndex,
                element: step,
                blockContainer: container,
                focusBlockId: container.dataset.focusBlockId // Assuming blockIndex is the focusBlockId
            });
        });
    });
    
    console.log(`Total steps across all blocks: ${allSteps.length}`);
    
    // Create dots for all steps
    createStepDots();
    
    // Show first step
    if (allSteps.length > 0) {
        showStep(0);
    }
}

function createStepDots() {
    const dotsContainer = document.getElementById('stepDots');
    
    // ‚úÖ CHECK if element exists
    if (!dotsContainer) {
        console.log('‚ö†Ô∏è stepDots container not found, skipping...');
        return;
    }
    
    // Continue with existing code only if element exists
    dotsContainer.innerHTML = '';
    
    allSteps.forEach((_, index) => {
        const dot = document.createElement('span');
        dot.className = 'step-dot';
        dot.onclick = () => goToStep(index);
        dotsContainer.appendChild(dot);
    });
}

function showStep(globalStepIndex) {
    if (globalStepIndex < 0 || globalStepIndex >= allSteps.length) return;
    
    // CHECK FOR BLOCK COMPLETION before switching
    checkBlockCompletion(globalStepIndex);
    
    const stepData = allSteps[globalStepIndex];
    
    // Hide all block containers
    blockContainers.forEach(container => container.style.display = 'none');
    
    // Hide all steps
    allSteps.forEach(step => step.element.style.display = 'none');
    
    // Show current block container and step
    stepData.blockContainer.style.display = 'block';
    stepData.element.style.display = 'block';
    
    // AUTO-START BLOCK TIMER when switching blocks
    if (stepData.blockIndex !== currentBlockIndex) {
        startBlockTimer(stepData.blockIndex);
    }
    
    // Update current indices
    currentBlockIndex = stepData.blockIndex;
    currentStepIndex = stepData.stepIndex;
    
    // Update UI
    updateUI(globalStepIndex);
}

function updateUI(globalStepIndex) {
    // Update indicators
    document.getElementById('blockIndicator').textContent = `Block ${currentBlockIndex + 1}`;
    document.getElementById('blockProgress').textContent = `Step ${currentStepIndex + 1} of ${blockContainers[currentBlockIndex].querySelectorAll('.study-step').length}`;
    
    // Update progress
    const progress = ((globalStepIndex + 1) / allSteps.length) * 100;
    document.getElementById('overallProgress').style.width = progress + '%';
    
    // Update navigation buttons
    document.getElementById('prevBtn').disabled = globalStepIndex === 0;
    
    const nextBtn = document.getElementById('nextBtn');
    if (globalStepIndex === allSteps.length - 1) {
        nextBtn.innerHTML = 'Complete All <i class="fas fa-trophy ms-1"></i>';
        nextBtn.classList.add('btn-success');
        nextBtn.classList.remove('btn-primary');
    } else {
        nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right ms-1"></i>';
        nextBtn.classList.add('btn-primary');
        nextBtn.classList.remove('btn-success');
    }
    
    // Update step dots
    updateStepDots(globalStepIndex);
}

function updateStepDots(currentIndex) {
    const dots = document.querySelectorAll('.step-dot');
    dots.forEach((dot, index) => {
        dot.classList.remove('active', 'completed');
        if (index === currentIndex) {
            dot.classList.add('active');
        } else if (index < currentIndex) {
            dot.classList.add('completed');
        }
    });
}

// Navigation functions
function nextStep() {
    const currentGlobalIndex = allSteps.findIndex(step => 
        step.blockIndex === currentBlockIndex && step.stepIndex === currentStepIndex
    );
    
    if (currentGlobalIndex < allSteps.length - 1) {
        showStep(currentGlobalIndex + 1);
    } else {
        // All blocks completed
        completeAllSessions();
    }
}

function previousStep() {
    const currentGlobalIndex = allSteps.findIndex(step => 
        step.blockIndex === currentBlockIndex && step.stepIndex === currentStepIndex
    );
    
    if (currentGlobalIndex > 0) {
        showStep(currentGlobalIndex - 1);
    }
}

function goToStep(globalStepIndex) {
    showStep(globalStepIndex);
}

function completeAllSessions() {
    alert('üéâ Congratulations! You have completed all focus blocks!');
    // TODO: Save completion data
}

// Utility functions
function toggleAnswer(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = element.style.display === 'none' ? 'block' : 'none';
    }
}

function revealAnswer(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = 'block';
        event.target.style.display = 'none';
    }
}

// Enhanced Timer System - REPLACE existing timer code with this:

// Global timer variables
let globalTimer = 0;
let globalTimerInterval = null;
let globalTimerRunning = false;

// Block timer variables  
let timers = {};
let timerIntervals = {};
let currentActiveTimer = null;

// Focus Block Completion System
let completionData = JSON.parse(localStorage.getItem('focusBlockCompletions') || '[]');
let currentCompletingBlock = null;

// Global Timer Functions
function startGlobalTimer() {
    if (!globalTimerRunning) {
        globalTimerInterval = setInterval(() => {
            globalTimer++;
            updateGlobalTimerDisplay();
        }, 1000);
        globalTimerRunning = true;
    }
    
    // AUTO-START FIRST BLOCK TIMER when session starts
    if (currentActiveTimer === null) {
        startBlockTimer(currentBlockIndex);
    }
    
    // Update buttons
    document.getElementById('global-start-btn').style.display = 'none';
    document.getElementById('global-pause-btn').style.display = 'inline-block';
    document.getElementById('global-stop-btn').style.display = 'inline-block';
    
    console.log('Global session timer started');
}

function pauseGlobalTimer() {
    if (globalTimerRunning) {
        clearInterval(globalTimerInterval);
        globalTimerRunning = false;
    }
    
    // Update buttons
    document.getElementById('global-start-btn').style.display = 'inline-block';
    document.getElementById('global-pause-btn').style.display = 'none';
    
    console.log('Global session timer paused');
}

function stopGlobalTimer() {
    clearInterval(globalTimerInterval);
    globalTimerRunning = false;
    
    // Stop current block timer too
    if (currentActiveTimer !== null) {
        stopBlockTimer(currentActiveTimer);
    }
    
    // Update buttons
    document.getElementById('global-start-btn').style.display = 'inline-block';
    document.getElementById('global-pause-btn').style.display = 'none';
    document.getElementById('global-stop-btn').style.display = 'none';
    
    // Show completion message
    const totalTime = formatTime(globalTimer);
    alert(`üìä Study Session Complete!\n\nTotal Time: ${totalTime}\n\nGreat job! üéâ`);
    
    console.log(`Global session completed. Total time: ${totalTime}`);
}

function updateGlobalTimerDisplay() {
    const timerElement = document.getElementById('global-timer');
    if (timerElement) {
        timerElement.textContent = `üïê ${formatTime(globalTimer)}`;
    }
}

// Block Timer Functions (Auto Start/Stop)
function startBlockTimer(blockIndex) {
    // Stop any currently running block timer
    if (currentActiveTimer !== null) {
        stopBlockTimer(currentActiveTimer);
    }
    
    // Initialize or resume timer for this block
    if (!timers[blockIndex]) {
        timers[blockIndex] = 0;
    }
    
    // Start interval
    timerIntervals[blockIndex] = setInterval(() => {
        timers[blockIndex]++;
        updateBlockTimerDisplay(blockIndex);
    }, 1000);
    
    currentActiveTimer = blockIndex;
    updateBlockTimerDisplay(blockIndex);
    
    console.log(`Block ${blockIndex} timer started`);
}

function stopBlockTimer(blockIndex) {
    if (timerIntervals[blockIndex]) {
        clearInterval(timerIntervals[blockIndex]);
        delete timerIntervals[blockIndex];
    }
    
    if (currentActiveTimer === blockIndex) {
        currentActiveTimer = null;
    }
    
    console.log(`Block ${blockIndex} timer stopped. Time: ${formatTime(timers[blockIndex] || 0)}`);
}

function updateBlockTimerDisplay(blockIndex) {
    const timerElement = document.getElementById(`timer-${blockIndex}`);
    if (timerElement) {
        timerElement.textContent = `‚è±Ô∏è ${formatTime(timers[blockIndex] || 0)}`;
    }
}

// Utility function
function formatTime(totalSeconds) {
    const hours = Math.floor(totalSeconds / 60);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Track block completion
function checkBlockCompletion(globalStepIndex) {
    // ‚úÖ Don't show completion modal during initialization
    if (isInitializing) {
        console.log('üîÑ Skipping completion check during initialization');
        return;
    }
    
    // Check if we're moving from the last step of a block to the first step of next block
    if (globalStepIndex > 0) {
        const currentStep = allSteps[globalStepIndex];
        const previousStep = allSteps[globalStepIndex - 1];
        
        // If we're switching to a new block, the previous block is complete
        if (currentStep.blockIndex !== previousStep.blockIndex) {
            const completedBlockIndex = previousStep.blockIndex;
            const completedBlockTime = timers[completedBlockIndex] || 0;
            
            // Show completion modal for the completed block
            showCompletionModal(completedBlockIndex, completedBlockTime);
        }
    }
}

function showCompletionModal(blockIndex, completionTime) {
    // ‚úÖ Don't show modal during initialization
    if (isInitializing) {
        console.log('üîÑ Skipping completion modal during initialization');
        return;
    }
    
    currentCompletingBlock = {
        blockIndex: blockIndex,
        completionTime: completionTime,
        timestamp: new Date().toISOString()
    };
    
    // Get block title
    const blockContainer = blockContainers[blockIndex];
    const blockTitle = blockContainer.querySelector('h3').textContent;
    
    // Update modal content
    document.getElementById('completed-block-title').textContent = blockTitle;
    document.getElementById('completed-block-time').textContent = formatTime(completionTime);
    
    // Reset rating
    document.querySelectorAll('input[name="proficiency"]').forEach(input => {
        input.checked = false;
    });
    document.getElementById('save-completion-btn').disabled = true;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('completionModal'));
    modal.show();
}

// ADD THIS SPACED REPETITION SYSTEM after the completion system:

// Spaced Repetition Configuration
const SPACED_REPETITION = {
    baseIntervals: [1, 3, 7, 21, 52, 120, 300], // days
    expectedTimes: {}, // will store expected times per block
    
    // Proficiency multipliers
    proficiencyMultipliers: {
        1: 0.5,  // Poor - review much sooner
        2: 0.7,  // Basic - review sooner  
        3: 0.9,  // Good - slight adjustment
        4: 1.2,  // Strong - extend interval
        5: 1.5   // Mastered - extend significantly
    },
    
    // Time performance multipliers
    getTimeMultiplier(actualTime, expectedTime) {
        if (!expectedTime) return 1.0;
        
        const ratio = actualTime / expectedTime;
        if (ratio < 0.7) return 1.2;      // Much faster = extend
        if (ratio > 1.5) return 0.8;     // Much slower = reduce
        return 1.0;                      // Normal time
    },
    
    // Calculate next review date
    calculateNextReview(blockIndex, proficiencyScore, completionTime) {
        const blockData = this.getBlockData(blockIndex);
        const currentLevel = blockData.repetitionLevel || 0;
        
        // Get base interval
        let interval = this.baseIntervals[Math.min(currentLevel, this.baseIntervals.length - 1)];
        
        // Apply proficiency multiplier
        const proficiencyMult = this.proficiencyMultipliers[proficiencyScore] || 1.0;
        interval *= proficiencyMult;
        
        // Apply time performance multiplier
        const expectedTime = this.getExpectedTime(blockIndex);
        const timeMult = this.getTimeMultiplier(completionTime, expectedTime);
        interval *= timeMult;
        
        // Calculate review date
        const reviewDate = new Date();
        reviewDate.setDate(reviewDate.getDate() + Math.round(interval));
        
        return {
            reviewDate: reviewDate,
            interval: Math.round(interval),
            nextLevel: this.getNextLevel(currentLevel, proficiencyScore)
        };
    },
    
    getNextLevel(currentLevel, proficiencyScore) {
        if (proficiencyScore >= 4) {
            return Math.min(currentLevel + 1, this.baseIntervals.length - 1);
        } else if (proficiencyScore <= 2) {
            return Math.max(currentLevel - 1, 0);
        }
        return currentLevel;
    },
    
    getBlockData(blockIndex) {
        const repetitionData = JSON.parse(localStorage.getItem('repetitionData') || '{}');
        return repetitionData[blockIndex] || { repetitionLevel: 0, reviewCount: 0 };
    },
    
    saveBlockData(blockIndex, data) {
        const repetitionData = JSON.parse(localStorage.getItem('repetitionData') || '{}');
        repetitionData[blockIndex] = data;
        localStorage.setItem('repetitionData', JSON.stringify(repetitionData));
    },
    
    getExpectedTime(blockIndex) {
        // Use the block's estimated duration or average from previous completions
        const blockContainer = blockContainers[blockIndex];
        const estimatedBadge = blockContainer.querySelector('.badge.bg-info');
        if (estimatedBadge) {
            const text = estimatedBadge.textContent;
            const minutes = parseInt(text.match(/(\d+)m/)?.[1] || '7');
            return minutes * 60; // Convert to seconds
        }
        return 420; // Default 7 minutes
    }
};

// REPLACE the saveCompletion function with this WORKING version:
async function saveCompletion() {
    console.log('üíæ saveCompletion called - HYBRID VERSION');
    
    const selectedRating = document.querySelector('input[name="proficiency"]:checked');
    if (!selectedRating) {
        console.log('‚ùå No rating selected');
        return;
    }
    
    const proficiencyScore = parseInt(selectedRating.value);
    const completionTime = currentCompletingBlock.completionTime;
    const blockIndex = currentCompletingBlock.blockIndex;
    
    console.log('üìä Saving completion:', { proficiencyScore, completionTime, blockIndex });
    
    // ‚úÖ STEP 1: Save to localStorage immediately (for progress tracking)
    saveToLocalStorageImmediate(blockIndex, proficiencyScore, completionTime);
    
    // ‚úÖ STEP 2: Save to database (for cross-platform sync)
    const currentBlock = allSteps.find(step => step.blockIndex === blockIndex);
    const focusBlockId = currentBlock ? currentBlock.focusBlockId : null;
    
    if (focusBlockId) {
        try {
            await saveToDatabaseAsync(focusBlockId, proficiencyScore, completionTime);
            console.log('‚úÖ Saved to both localStorage and database');
        } catch (error) {
            console.log('‚ö†Ô∏è Database save failed, but localStorage save succeeded:', error);
            showToast('‚úÖ Progress saved locally. Will sync when online.', 'warning');
        }
    }
    
    // ‚úÖ Show success and continue (regardless of database result)
    showToast(`‚úÖ Block completed! Rating: ${proficiencyScore}/5`);
    
    // Close modal and continue
    const modal = bootstrap.Modal.getInstance(document.getElementById('completionModal'));
    if (modal) {
        modal.hide();
    }
    
    setTimeout(() => {
        nextStep();
    }, 1000);
}

// ‚úÖ IMMEDIATE localStorage save (for progress tracking)
function saveToLocalStorageImmediate(blockIndex, proficiencyScore, completionTime) {
    console.log('üíæ Saving to localStorage immediately');
    
    // Get current completion data
    let completionData = JSON.parse(localStorage.getItem('focusBlockCompletions') || '[]');
    
    // Calculate next review using spaced repetition
    const repetitionInfo = SPACED_REPETITION.calculateNextReview(
        blockIndex, 
        proficiencyScore, 
        completionTime
    );
    
    // Update repetition data
    let repetitionData = JSON.parse(localStorage.getItem('repetitionData') || '{}');
    repetitionData[blockIndex] = {
        lastCompleted: new Date().toISOString(),
        lastProficiency: proficiencyScore,
        averageTime: repetitionData[blockIndex] ? 
            (repetitionData[blockIndex].averageTime + completionTime) / 2 : completionTime,
        repetitionLevel: repetitionInfo.nextLevel,
        nextReview: repetitionInfo.reviewDate.toISOString()
    };
    localStorage.setItem('repetitionData', JSON.stringify(repetitionData));
    
    // Save completion record
    const completion = {
        blockIndex: blockIndex,
        blockTitle: allSteps.find(step => step.blockIndex === blockIndex)?.title || `Block ${blockIndex + 1}`,
        proficiencyRating: proficiencyScore,
        completionTime: completionTime,
        completedAt: new Date().toISOString(),
        nextReviewDate: repetitionInfo.reviewDate.toISOString(),
        interval: repetitionInfo.interval,
        repetitionLevel: repetitionInfo.nextLevel
    };
    
    completionData.push(completion);
    localStorage.setItem('focusBlockCompletions', JSON.stringify(completionData));
    
    console.log('‚úÖ Saved to localStorage:', completion);
    return completion;
}

// ‚úÖ Async database save (doesn't block progress)
async function saveToDatabaseAsync(focusBlockId, proficiencyScore, completionTime) {
    console.log('üåê Saving to database (async)...');
    
    const response = await fetch(`/api/focus-block/${focusBlockId}/complete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            'proficiency_score': proficiencyScore,
            'completion_time': completionTime
        })
    });
    
    if (!response.ok) {
        throw new Error(`Database save failed: ${response.status}`);
    }
    
    const result = await response.json();
    if (!result.success) {
        throw new Error(result.error || 'Database save failed');
    }
    
    console.log('‚úÖ Database save successful:', result);
    return result;
}

// Helper function to save locally as backup only
function saveToLocalStorageBackup(blockIndex, proficiencyScore, completionTime, dbResult) {
    console.log('üíæ Saving backup to localStorage');
    let completionData = JSON.parse(localStorage.getItem('focusBlockCompletions') || '[]');
    
    const completion = {
        blockIndex: blockIndex,
        blockTitle: `Block ${blockIndex + 1}`,
        proficiencyRating: proficiencyScore,
        completionTime: completionTime,
        completedAt: new Date().toISOString(),
        nextReviewDate: dbResult.next_review_date,
        interval: dbResult.interval_days,
        savedToDatabase: true,
        sessionId: dbResult.session_id
    };
    
    completionData.push(completion);
    localStorage.setItem('focusBlockCompletions', JSON.stringify(completionData));
}

// Helper function for CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showToast(message, type = 'success') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `position-fixed top-0 start-50 translate-middle-x alert alert-${type} alert-dismissible mt-3`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    document.body.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 3000);
}

// Enable save button when rating is selected
document.addEventListener('change', function(e) {
    if (e.target.name === 'proficiency') {
        document.getElementById('save-completion-btn').disabled = false;
    }
});

function viewCompletions() {
    const completions = JSON.parse(localStorage.getItem('focusBlockCompletions') || '[]');
    const dueBlocks = getBlocksDueForReview();
    
    if (completions.length === 0) {
        alert('No completed focus blocks yet. Complete some blocks to see your progress!');
        return;
    }
    
    let report = 'üìä FOCUS BLOCK PROGRESS & SPACED REPETITION\n\n';
    
    // Due for review section
    if (dueBlocks.length > 0) {
        report += 'üîî DUE FOR REVIEW TODAY:\n';
        dueBlocks.forEach((block, index) => {
            const overdueText = block.daysOverdue > 0 ? `
{# templates/flashcards/all_focus_blocks.html #}
{% extends 'flashcards/base.html' %}

{% block title %}Advanced Study – Exocortex{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- Hidden StudySession data for JS -->
    <div id="session-data"
         data-session-id="{{ study_session.id|default:'' }}"
         style="display:none;"></div>

    {# ────────────────────── NO BLOCKS STATE ────────────────────── #}
    {% if no_blocks %}
    <div class="row justify-content-center">
        <div class="col-md-8 text-center py-5">
            <i class="fas fa-target fa-4x text-muted mb-4"></i>
            <h3 class="text-muted">No Focus Blocks Yet</h3>
            <p class="text-muted mb-4">Upload PDFs to generate AI-powered focus blocks.</p>
            <a href="{% url 'flashcards:home' %}" class="btn btn-primary btn-lg">
                <i class="fas fa-upload me-2"></i>Upload Your First PDF
            </a>
        </div>
    </div>

    {% else %}
    {# ───────────────────────── HEADER ──────────────────────────── #}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white d-flex justify-content-between">
                    <div>
                        <h3 class="mb-1"><i class="fas fa-brain me-2"></i>Advanced Study Session</h3>
                        <p class="mb-0">
                            <i class="fas fa-layer-group me-1"></i>{{ total_blocks }} Focus Blocks
                            <span class="badge bg-light text-primary ms-2">
                                {{ total_study_time|floatformat:0 }} min total
                            </span>
                        </p>
                    </div>
                </div>
                <div class="progress" style="height:8px;">
                    <div class="progress-bar bg-success" id="main-progress"
                         style="width:{{ progress_percentage }}%"></div>
                </div>
            </div>
        </div>
    </div>

    {# ─────────────────── MAIN LAYOUT (2-column) ─────────────────── #}
    <div class="row">
        <!-- ~~~~~~~~~ MAIN STUDY COLUMN ~~~~~~~~~ -->
        <div class="col-lg-8">

        {% for block_data in focus_blocks %}
            {# ===== Learning Objectives ====================================== #}
            {% if block_data.learning_objectives %}
            <div class="card mb-4"
                 id="block-{{ forloop.counter0 }}"
                 style="{% if not forloop.first %}display:none;{% endif %}">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-bullseye me-2"></i>Learning Objectives</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        {% for objective in block_data.learning_objectives %}
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>{{ objective }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            {# ===== Segments Card =========================================== #}
            <div class="card mb-4"
                 id="segments-{{ forloop.counter0 }}"
                 style="{% if not forloop.first %}display:none;{% endif %}">
                <div class="card-header bg-success text-white d-flex justify-content-between">
                    <h5 class="mb-0">
                        <i class="fas fa-chalkboard-teacher me-2"></i>{{ block_data.block.title }}
                    </h5>
                    <span class="badge bg-light text-dark">
                        Block <span id="current-block">{{ forloop.counter }}</span>
                        / {{ focus_blocks|length }}
                    </span>
                </div>

                <div class="card-body">
                    {% for segment in block_data.segments %}
                    <div class="segment-container mb-4 p-3 border rounded"
                         id="segment-{{ forloop.parentloop.counter0 }}-{{ forloop.counter0 }}"
                         data-segment-index="{{ forloop.counter0 }}"
                         data-block-index="{{ forloop.parentloop.counter0 }}"
                         style="{% if not forloop.first %}display:none;{% endif %}">

                        {# --- Segment header ---------------------------------- #}
                        <div class="segment-header d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-primary mb-0">
                                <span class="badge bg-primary me-2">{{ forloop.counter }}</span>
                                {{ segment.type|default:"Learning Segment"|title }}
                            </h6>
                            <div>
                                <span class="badge bg-secondary">
                                    {{ segment.time_sec|default:60 }}s
                                </span>
                                <button class="btn btn-sm btn-outline-success ms-2"
                                        onclick="markSegmentComplete({{ forloop.parentloop.counter0 }}, {{ forloop.counter0 }})">
                                    <i class="fas fa-check"></i> Complete
                                </button>
                            </div>
                        </div>

                        {# --- Segment content chunks -------------------------- #}
                        {% if segment.content %}
                        <div class="content-section mb-3">
                            {% if segment.type == 'knowledge_check' %}
                                {# Q&A Segment with proper reveal #}
                                <div class="qa-segment p-3 bg-warning bg-opacity-10 rounded border border-warning">
                                    <h6 class="text-warning mb-3">
                                        <i class="fas fa-question-circle me-2"></i>{{ segment.title }}
                                    </h6>
                                    
                                    {# Question (always visible) #}
                                    <div class="question-display mb-3 p-3 bg-white rounded">
                                        <strong>{{ segment.question }}</strong>
                                    </div>
                                    
                                    {# Reveal Answer Button #}
                                    <div class="text-center mb-3">
                                        <button class="btn btn-primary" onclick="revealAnswer('qa_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}')">
                                            <i class="fas fa-eye me-1"></i>
                                            <span id="qa_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}_btntext">Show Answer</span>
                                        </button>
                                    </div>
                                    
                                    {# Hidden Answer #}
                                    <div id="qa_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" style="display:none;">
                                        <div class="alert alert-success">
                                            <h6><i class="fas fa-lightbulb"></i> Answer:</h6>
                                            {{ segment.answer }}
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                {# Regular Content Segment #}
                                <div class="p-3 bg-light rounded border-start border-4 border-primary">
                                    {{ segment.content|safe }}
                                </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if segment.explanation %}
                        <div class="explanation-section mb-3">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-lightbulb text-warning"></i> Key Insight:</h6>
                                {{ segment.explanation|linebreaks }}
                            </div>
                        </div>
                        {% endif %}

                        {% if segment.examples %}
                        <div class="examples-section mb-3">
                            <h6><i class="fas fa-list-alt text-success"></i> Examples:</h6>
                            <div class="row">
                                {% for example in segment.examples %}
                                <div class="col-md-6 mb-2">
                                    <div class="card border-success">
                                        <div class="card-body p-2"><small>{{ example }}</small></div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {# --- Personal notes ---------------------------------- #}
                        <div class="segment-notes mt-3">
                            <label class="form-label small text-muted">
                                <i class="fas fa-sticky-note"></i> Your notes for this segment:
                            </label>
                            <textarea class="form-control"
                                      placeholder="Quick notes, questions, or insights…"
                                      data-block="{{ forloop.parentloop.counter0 }}"
                                      data-segment="{{ forloop.counter0 }}"
                                      onchange="saveSegmentNote({{ forloop.parentloop.counter0 }}, {{ forloop.counter0 }}, this.value)"></textarea>
                        </div>
                    </div>
                    {% endfor %}

                    {# --- Segment navigation bar ----------------------------- #}
                    <div class="segment-navigation-controls d-flex justify-content-between mt-4">
                        <button class="btn btn-outline-secondary"
                                id="prev-btn-{{ forloop.counter0 }}"
                                onclick="previousSegment({{ forloop.counter0 }})"
                                disabled>
                            <i class="fas fa-chevron-left me-2"></i>Previous
                        </button>

                        <div class="segment-progress">
                            <div class="progress" style="width:200px;height:8px;">
                                <div class="progress-bar bg-success"
                                     id="segment-progress-bar-{{ forloop.counter0 }}"
                                     style="width:0%"></div>
                            </div>
                        </div>

                        <button class="btn btn-primary"
                                id="next-btn-{{ forloop.counter0 }}"
                                onclick="nextSegment({{ forloop.counter0 }})">
                            Next<i class="fas fa-chevron-right ms-2"></i>
                        </button>
                    </div>
                </div>
            </div>

            {# ===== Knowledge-Check Card ==================================== #}
            {% if block_data.qa_items %}
            <div class="card mb-4"
                 id="qa-{{ forloop.counter0 }}"
                 style="{% if not forloop.first %}display:none;{% endif %}">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-question-circle me-2"></i>Knowledge Check
                    </h5>
                </div>

                <div class="card-body">
                    {% for qa_item in block_data.qa_items %}
                    {% with qid='qa'|add:forloop.parentloop.counter0|add:'_'|add:forloop.counter0 %}
                    <div class="qa-section mb-4 p-3 border rounded">

                        <!-- Question -->
                        <div class="question mb-3">
                            <strong class="text-info">
                                <i class="fas fa-question-circle me-2"></i>{{ qa_item.question }}
                            </strong>
                        </div>

                        <!-- Toggle button -->
                        <div class="qa-actions text-center mb-3">
                            <button class="btn btn-outline-primary"
                                    onclick="revealAnswer('{{ qid }}')">
                                <i class="fas fa-eye me-1"></i>
                                <span id="{{ qid }}_btntext">Show Answer</span>
                            </button>
                        </div>

                        <!-- Hidden answer -->
                        <div class="answer-section"
                             id="{{ qid }}"
                             style="display:none;">
                            <div class="alert alert-success">
                                <h6><i class="fas fa-check-circle"></i> Answer:</h6>
                                {{ qa_item.answer|linebreaks }}
                            </div>

                            <!-- Self-rating -->
                            <div class="understanding-check mt-3">
                                <p class="small text-muted mb-2">
                                    How well did you understand this?
                                </p>
                                <div class="btn-group btn-group-sm" role="group">
                                    {% for i in "12345" %}
                                    <input type="radio"
                                           class="btn-check"
                                           name="{{ qid }}_rating"
                                           id="{{ qid }}_{{ i }}">
                                    <label class="btn btn-outline-primary"
                                           for="{{ qid }}_{{ i }}">{{ i }}</label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        {% if qa_item.tag %}
                        <small class="badge bg-secondary mt-2">{{ qa_item.tag }}</small>
                        {% endif %}
                    </div>
                    {% endwith %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        {% endfor %}  {# End for block loop #}
        </div><!-- /col-lg-8 -->

        <!-- ~~~~~~~~~ SIDEBAR COLUMN ~~~~~~~~~ -->
        <div class="col-lg-4">
            {# ===== Study Progress Card ===================================== #}
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-line text-success"></i> Study Progress
                    </h6>
                </div>
                <div class="card-body">
                    <div class="progress-item mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>Overall Progress</small>
                            <small id="progress-text">{{ progress_percentage }}%</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar"
                                 id="sidebar-progress"
                                 style="width:{{ progress_percentage }}%"></div>
                        </div>
                    </div>

                    <div class="study-stats">
                        <div class="stat-item d-flex justify-content-between">
                            <span>Current Block:</span>
                            <span><span id="current-block-number">1</span>/{{ focus_blocks|length }}</span>
                        </div>
                        <div class="stat-item d-flex justify-content-between">
                            <span>Segments:</span>
                            <span>
                                <span id="completed-segments">0</span>/
                                <span id="total-segments">{{ focus_blocks.0.total_segments }}</span>
                            </span>
                        </div>
                        <div class="stat-item d-flex justify-content-between">
                            <span>Q&A Items:</span>
                            <span id="current-qa-count">{{ focus_blocks.0.total_qa }}</span>
                        </div>
                        <div class="stat-item d-flex justify-content-between">
                            <span>Est. Time:</span>
                            <span id="current-duration">{{ focus_blocks.0.estimated_duration }}</span>
                        </div>
                    </div>
                </div>
            </div>

            {# ===== Timer Card ============================================== #}
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-clock text-warning"></i> Study Timer
                    </h6>
                    <button class="btn btn-sm btn-outline-warning"
                            id="sidebar-pause-btn"
                            onclick="togglePause()">
                        <i class="fas fa-pause" id="sidebar-pause-icon"></i>
                        <i class="fas fa-play d-none" id="sidebar-play-icon"></i>
                    </button>
                </div>
                <div class="card-body text-center">
                    <div class="timer-display mb-3">
                        <div class="h4 text-primary mb-1" id="session-timer">00:00:00</div>
                        <small class="text-muted">Total Session Time</small>
                    </div>
                    <div class="timer-display">
                        <div class="h5 text-success mb-1" id="block-timer">00:00</div>
                        <small class="text-muted">Current Block</small>
                    </div>
                </div>
            </div>

            {# ===== Session Notes ========================================== #}
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-edit text-primary"></i> Session Notes
                    </h6>
                </div>
                <div class="card-body">
                    <textarea class="form-control"
                              rows="6"
                              id="session-notes"
                              placeholder="General thoughts, connections, insights…"></textarea>
                    <div class="mt-2 text-end">
                        <small class="text-muted">Auto-saved</small>
                    </div>
                </div>
            </div>
        </div><!-- /col-lg-4 -->
    </div><!-- /row -->
    {% endif %}
</div><!-- /container-fluid -->

{# ──────────────────── JAVASCRIPT ──────────────────── #}
<script>
/* ---------- Knowledge-check toggle ------------------ */
function revealAnswer(id){
    const panel   = document.getElementById(id);
    const btnText = document.getElementById(id + '_btntext');

    if(!panel){ console.warn('Answer panel not found:', id); return; }

    const hidden = panel.style.display === 'none' || panel.style.display === '';
    panel.style.display = hidden ? 'block' : 'none';
    if(btnText){
        btnText.textContent = hidden ? 'Hide Answer' : 'Show Answer';
    }
}

/* ---------- Segment Q&A reveal functionality ---------- */
function revealSegmentAnswer(id) {
    const panel = document.getElementById(id);
    const btnText = document.getElementById(id + '_btntext');
    
    if (!panel) { 
        console.warn('Answer panel not found:', id); 
        return; 
    }
    
    const hidden = panel.style.display === 'none' || panel.style.display === '';
    panel.style.display = hidden ? 'block' : 'none';
    
    if (btnText) {
        btnText.textContent = hidden ? 'Hide Answer' : 'Show Answer';
    }
}

/* ---------- Minimal navigation & progress ------------ */
/* Your original JS for showSegment / nextSegment / markSegmentComplete / getCookie etc.
   is copied unchanged below; only trimmed comments for brevity. */

let currentBlockIndex = 0;
let currentSegmentIndex = 0;

document.addEventListener('DOMContentLoaded', () => {
    showSegment(0,0);
});

function showBlock(blockIdx){
    const allBlocks = document.querySelectorAll('[id^="segments-"]');
    allBlocks.forEach(b => b.style.display = 'none');
    const target = document.getElementById('segments-' + blockIdx);
    if(target){
        target.style.display = 'block';
        currentBlockIndex = blockIdx;
        currentSegmentIndex = 0;
        showSegment(blockIdx,0);
    }
}

function showSegment(blockIdx, segIdx){
    if(segIdx === currentSegmentIndex){ return; }
    const allSeg = document.querySelectorAll(`[id^="segment-${blockIdx}-"]`);
    allSeg.forEach(s => s.style.display = 'none');
    const target = document.getElementById(`segment-${blockIdx}-${segIdx}`);
    if(target){
        target.style.display = 'block';
        currentSegmentIndex = segIdx;
    }
    updateNavigationButtons(blockIdx);
}

function nextSegment(blockIdx){
    markSegmentComplete(blockIdx, currentSegmentIndex);
    const nextIdx = currentSegmentIndex + 1;
    const exists  = document.getElementById(`segment-${blockIdx}-${nextIdx}`);
    if(exists){ showSegment(blockIdx, nextIdx); }
}

function previousSegment(blockIdx){
    if(currentSegmentIndex > 0){
        showSegment(blockIdx, currentSegmentIndex - 1);
    }
}

function updateNavigationButtons(blockIdx){
    const prevBtn = document.getElementById('prev-btn-' + blockIdx);
    const nextBtn = document.getElementById('next-btn-' + blockIdx);
    if(prevBtn){ prevBtn.disabled = currentSegmentIndex === 0; }
    if(nextBtn){
        nextBtn.disabled = false;
    }
}

function updateProgressDisplay(percent, completedSeg){
    document.getElementById('sidebar-progress').style.width = percent + '%';
    document.getElementById('progress-text').textContent    = Math.round(percent) + '%';
    document.getElementById('completed-segments').textContent = completedSeg;
}

function markSegmentComplete(blockIdx, segIdx){
    const seg = document.getElementById(`segment-${blockIdx}-${segIdx}`);
    if(seg){
        seg.style.backgroundColor = '#d4edda';
        seg.style.border          = '2px solid #155724';
    }

    const sessionId = document.getElementById('session-data').dataset.sessionId;
    if(!sessionId){ return; }

    fetch('/mark-segment-complete/', {
        method : 'POST',
        headers: {
            'Content-Type':'application/json',
            'X-CSRFToken'  : getCookie('csrftoken')
        },
        body: JSON.stringify({
            session_id    : sessionId,
            segment_index : segIdx
        })
    })
    .then(r => r.json())
    .then(data => {
        if(data.success){
            updateProgressDisplay(data.progress, segIdx + 1);
            if(data.advanced_to_next){ setTimeout(() => location.reload(), 1000); }
            if(data.all_completed){ alert('🎉 All focus blocks completed!'); }
        }else{
            alert('Error: ' + (data.error || 'unknown'));
        }
    })
    .catch(e => alert('Network error'));
}

function getCookie(name){
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if(parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
    return '';
}
</script>

{# ────────────────────── STYLES ─────────────────────── #}
<style>
.segment-container{transition:all .3s ease;}
.timer-display{font-family:'Courier New',monospace;}
.stat-item{padding:.25rem 0;border-bottom:1px solid #eee;}
.stat-item:last-child{border-bottom:none;}
.progress-item{margin-bottom:1rem;}
</style>
{% endblock %}
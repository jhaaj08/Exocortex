{% extends 'flashcards/base.html' %}

{% block title %}Advanced Study - Exocortex{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- ✅ ADD: Hidden session data -->
    <div id="session-data" 
         data-session-id="{{ focus_session.id|default:'' }}" 
         style="display: none;"></div>
    
    {% if no_blocks %}
    <!-- No Focus Blocks State -->
    <div class="row justify-content-center">
        <div class="col-md-8 text-center py-5">
            <i class="fas fa-target fa-4x text-muted mb-4"></i>
            <h3 class="text-muted">No Focus Blocks Yet</h3>
            <p class="text-muted mb-4">Upload PDFs to generate AI-powered focus blocks</p>
            <a href="{% url 'flashcards:home' %}" class="btn btn-primary btn-lg">
                <i class="fas fa-upload me-2"></i>Upload Your First PDF
            </a>
        </div>
    </div>
    
    {% else %}
    
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-1">
                                <i class="fas fa-brain me-2"></i>Advanced Study Session
                            </h3>
                            <p class="mb-0">
                                <i class="fas fa-layer-group me-1"></i>{{ total_blocks }} Focus Blocks
                                <span class="badge bg-light text-primary ms-2">{{ total_study_time|floatformat:0 }}min total</span>
                            </p>
                        </div>
                    </div>
                </div>
                <!-- Enhanced Progress Bar -->
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-success" id="main-progress" 
                         style="width: {{ progress_percentage }}%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Study Content -->
        <div class="col-lg-8">
            {% for block_data in focus_blocks %}
            <!-- Learning Objectives -->
            {% if block_data.learning_objectives %}
            <div class="card mb-4" id="block-{{ forloop.counter0 }}" style="{% if not forloop.first %}display: none;{% endif %}">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-bullseye me-2"></i>Learning Objectives</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        {% for objective in block_data.learning_objectives %}
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>{{ objective }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Interactive Learning Segments -->
            <div class="card mb-4" id="segments-{{ forloop.counter0 }}" style="{% if not forloop.first %}display: none;{% endif %}">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chalkboard-teacher me-2"></i>{{ block_data.block.title }}</h5>
                    <div class="block-navigation">
                        <span class="badge bg-light text-dark me-2">
                            Block <span id="current-block">{{ forloop.counter }}</span> of {{ focus_blocks|length }}
                        </span>
        </div>
                </div>
                <div class="card-body">
                    {% for segment in block_data.segments %}
                    <div class="segment-container mb-4 p-3 border rounded" 
                         id="segment-{{ forloop.parentloop.counter0 }}-{{ forloop.counter0 }}" 
                         data-segment-index="{{ forloop.counter0 }}"
                         data-block-index="{{ forloop.parentloop.counter0 }}"
                         style="{% if not forloop.first %}display: none;{% endif %}">
                        
                        <div class="segment-header d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-primary mb-0">
                                <span class="badge bg-primary me-2">{{ forloop.counter }}</span>
                                {{ segment.type|default:"Learning Segment"|title }}
                            </h6>
                            <div>
                                <span class="badge bg-secondary">{{ segment.time_sec|default:60 }}s</span>
                                <button class="btn btn-sm btn-outline-success ms-2" 
                                        onclick="markSegmentComplete({{ forloop.parentloop.counter0 }}, {{ forloop.counter0 }})">
                                    <i class="fas fa-check"></i> Complete
                                </button>
                            </div>
                        </div>
                        
                        <!-- Segment Content -->
                        {% if segment.content %}
                        <div class="content-section mb-3">
                            <div class="p-3 bg-light rounded border-start border-4 border-primary">
                                {{ segment.content|linebreaks }}
                            </div>
                        </div>
                        {% endif %}

                        {% if segment.explanation %}
                        <div class="explanation-section mb-3">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-lightbulb text-warning"></i> Key Insight:</h6>
                                {{ segment.explanation|linebreaks }}
                    </div>
                </div>
                                        {% endif %}

                        {% if segment.examples %}
                        <div class="examples-section mb-3">
                            <h6><i class="fas fa-list-alt text-success"></i> Examples:</h6>
                            <div class="row">
                                {% for example in segment.examples %}
                                <div class="col-md-6 mb-2">
                                    <div class="card border-success">
                                        <div class="card-body p-2">
                                            <small>{{ example }}</small>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                                    </div>
                                    {% endif %}
                                    
                        <!-- Segment Notes -->
                        <div class="segment-notes mt-3">
                            <label class="form-label small text-muted">
                                <i class="fas fa-sticky-note"></i> Your notes for this segment:
                            </label>
                            <textarea class="form-control" 
                                      placeholder="Quick notes, questions, or insights..."
                                      data-block="{{ forloop.parentloop.counter0 }}"
                                      data-segment="{{ forloop.counter0 }}"
                                      onchange="saveSegmentNote({{ forloop.parentloop.counter0 }}, {{ forloop.counter0 }}, this.value)"></textarea>
                                            </div>
                                        </div>
                    {% endfor %}
                    
                    <!-- Navigation Controls -->
                    <div class="segment-navigation-controls d-flex justify-content-between align-items-center mt-4">
                        <button class="btn btn-outline-secondary" id="prev-btn-{{ forloop.counter0 }}" onclick="previousSegment({{ forloop.counter0 }})" disabled>
                            <i class="fas fa-chevron-left me-2"></i>Previous
                        </button>
                        
                        <!-- Simple Progress Bar -->
                        <div class="segment-progress">
                            <div class="progress" style="width: 200px; height: 8px;">
                                <div class="progress-bar bg-success" id="segment-progress-bar-{{ forloop.counter0 }}" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    
                        <button class="btn btn-primary" id="next-btn-{{ forloop.counter0 }}" onclick="nextSegment({{ forloop.counter0 }})">
                            Next<i class="fas fa-chevron-right ms-2"></i>
                        </button>
                                                </div>
                                            </div>
                                        </div>

            <!-- Q&A Section -->
            {% if block_data.qa_items %}
            <div class="card mb-4" id="qa-{{ forloop.counter0 }}" style="{% if not forloop.first %}display: none;{% endif %}">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i>Knowledge Check</h5>
                                    </div>
                <div class="card-body">
                    {% for qa_item in block_data.qa_items %}
                    <div class="qa-section mb-4 p-3 border rounded">
                        <div class="question-header mb-3">
                            <h6 class="text-primary">Question {{ forloop.counter }}:</h6>
                            <p class="fs-5">{{ qa_item.question }}</p>
                                        </div>
                                        
                        <div class="qa-actions text-center mb-3">
                            <button class="btn btn-outline-primary" 
                                    onclick="revealAnswer('qa{{ forloop.parentloop.counter0 }}_{{ forloop.counter }}')">
                                <i class="fas fa-eye me-1"></i>Show Answer
                                            </button>
                                        </div>
                                        
                        <div class="answer-section" id="qa{{ forloop.parentloop.counter0 }}_{{ forloop.counter }}" style="display: none;">
                            <div class="alert alert-success">
                                <h6><i class="fas fa-check-circle"></i> Answer:</h6>
                                {{ qa_item.answer|linebreaks }}
                                    </div>
                                    
                            <!-- Understanding Check -->
                            <div class="understanding-check mt-3">
                                <p class="small text-muted mb-2">How well did you understand this?</p>
                                <div class="btn-group btn-group-sm" role="group">
                                    {% for i in "12345" %}
                                    <input type="radio" class="btn-check" name="qa{{ forloop.parentloop.counter0 }}_{{ forloop.parentloop.counter }}_understanding" id="qa{{ forloop.parentloop.counter0 }}_{{ forloop.parentloop.counter }}_{{ i }}">
                                    <label class="btn btn-outline-primary" for="qa{{ forloop.parentloop.counter0 }}_{{ forloop.parentloop.counter }}_{{ i }}">{{ i }}</label>
                                            {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endfor %}
                </div>
                
        <!-- Study Sidebar -->
        <div class="col-lg-4">
            <!-- Study Progress -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-chart-line text-success"></i> Study Progress</h6>
                        </div>
                <div class="card-body">
                    <div class="progress-item mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>Overall Progress</small>
                            <small id="progress-text">{{ progress_percentage }}%</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" id="sidebar-progress" style="width: {{ progress_percentage }}%"></div>
                        </div>
                    </div>
                    
                    <div class="study-stats">
                        <div class="stat-item d-flex justify-content-between">
                            <span>Current Block:</span>
                            <span><span id="current-block-number">1</span>/{{ focus_blocks|length }}</span>
                        </div>
                        <div class="stat-item d-flex justify-content-between">
                            <span>Segments:</span>
                            <span><span id="completed-segments">0</span>/<span id="total-segments">{{ focus_blocks.0.total_segments }}</span></span>
                        </div>
                        <div class="stat-item d-flex justify-content-between">
                            <span>Q&A Items:</span>
                            <span id="current-qa-count">{{ focus_blocks.0.total_qa }}</span>
                        </div>
                        <div class="stat-item d-flex justify-content-between">
                            <span>Est. Time:</span>
                            <span id="current-duration">{{ focus_blocks.0.estimated_duration }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timer Card -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-clock text-warning"></i> Study Timer</h6>
                    <div class="timer-controls">
                        <button class="btn btn-sm btn-outline-warning" id="sidebar-pause-btn" onclick="togglePause()">
                            <i class="fas fa-pause" id="sidebar-pause-icon"></i>
                            <i class="fas fa-play d-none" id="sidebar-play-icon"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body text-center">
                    <div class="timer-display mb-3">
                        <div class="h4 text-primary mb-1" id="session-timer">00:00:00</div>
                        <small class="text-muted">Total Session Time</small>
                    </div>
                    <div class="timer-display">
                        <div class="h5 text-success mb-1" id="block-timer">00:00</div>
                        <small class="text-muted">Current Block</small>
        </div>
    </div>
            </div>

            <!-- Real-time Notes -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-edit text-primary"></i> Session Notes</h6>
                </div>
                <div class="card-body">
                    <textarea class="form-control" rows="6" id="session-notes" 
                              placeholder="General thoughts, connections, insights..."></textarea>
                    <div class="mt-2 text-end">
                        <small class="text-muted">Auto-saved</small>
                    </div>
            </div>
        </div>
    </div>
</div>
    
    {% endif %}
</div>

<script>
// Global variables
let currentBlockIndex = 0;
let currentSegmentIndex = 0;
const totalBlocks = {{ focus_blocks|length }};
let segmentNotes = {};
let isPaused = false;
let sessionTimer = null;
let blockTimer = null;
let sessionStartTime = null;
let blockStartTime = null;
let totalPausedTime = 0;
let pauseStartTime = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log(`🚀 Advanced Study initialized with ${totalBlocks} blocks`);
    startTimers();
    showBlock(0);
});

// Timer Functions
function startTimers() {
    console.log('⏱️ Starting timers...');
    const now = new Date();
    if (!sessionStartTime) sessionStartTime = now;
    blockStartTime = now;
    
    if (sessionTimer) clearInterval(sessionTimer);
    if (blockTimer) clearInterval(blockTimer);
    
    sessionTimer = setInterval(updateSessionTimer, 1000);
    blockTimer = setInterval(updateBlockTimer, 1000);
}

function updateSessionTimer() {
    if (isPaused) return;
    const now = new Date();
    const elapsed = now - sessionStartTime - totalPausedTime;
    const sessionTimerEl = document.getElementById('session-timer');
    if (sessionTimerEl) {
        sessionTimerEl.textContent = formatTime(elapsed);
    }
}

function updateBlockTimer() {
    if (isPaused) return;
    const now = new Date();
    const elapsed = now - blockStartTime;
    const blockTimerEl = document.getElementById('block-timer');
    if (blockTimerEl) {
        blockTimerEl.textContent = formatTime(elapsed, false);
    }
}

function formatTime(milliseconds, includeHours = true) {
    const totalSeconds = Math.floor(milliseconds / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    
    if (includeHours) {
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    } else {
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
}

function togglePause() {
    const sidebarPauseBtn = document.getElementById('sidebar-pause-btn');
    const sidebarPauseIcon = document.getElementById('sidebar-pause-icon');
    const sidebarPlayIcon = document.getElementById('sidebar-play-icon');
    
    isPaused = !isPaused;
    
    if (isPaused) {
        clearInterval(sessionTimer);
        clearInterval(blockTimer);
        pauseStartTime = new Date();
        
        if (sidebarPauseIcon) sidebarPauseIcon.classList.add('d-none');
        if (sidebarPlayIcon) sidebarPlayIcon.classList.remove('d-none');
        if (sidebarPauseBtn) sidebarPauseBtn.className = 'btn btn-sm btn-success';
        
        console.log('⏸️ Session paused');
    } else {
        if (pauseStartTime) {
            totalPausedTime += new Date() - pauseStartTime;
            pauseStartTime = null;
        }
        startTimers();
        
        if (sidebarPauseIcon) sidebarPauseIcon.classList.remove('d-none');
        if (sidebarPlayIcon) sidebarPlayIcon.classList.add('d-none');
        if (sidebarPauseBtn) sidebarPauseBtn.className = 'btn btn-sm btn-outline-warning';
        
        console.log('▶️ Session resumed');
    }
}

// Block Navigation
function showBlock(blockIndex) {
    console.log(`📚 Showing block ${blockIndex + 1} of ${totalBlocks}`);
    
    // Hide all blocks
    for (let i = 0; i < totalBlocks; i++) {
        const block = document.getElementById(`block-${i}`);
        const segments = document.getElementById(`segments-${i}`);
        const qa = document.getElementById(`qa-${i}`);
        if (block) block.style.display = 'none';
        if (segments) segments.style.display = 'none';
        if (qa) qa.style.display = 'none';
    }
    
    // Show current block
    const currentBlock = document.getElementById(`block-${blockIndex}`);
    const currentSegments = document.getElementById(`segments-${blockIndex}`);
    const currentQa = document.getElementById(`qa-${blockIndex}`);
    
    if (currentBlock) currentBlock.style.display = 'block';
    if (currentSegments) currentSegments.style.display = 'block';
    if (currentQa) currentQa.style.display = 'block';
    
    currentBlockIndex = blockIndex;
    currentSegmentIndex = 0;
    
    // Reset block timer
    blockStartTime = new Date();
    
    // Update UI
    const currentBlockEl = document.getElementById('current-block');
    const currentBlockNumberEl = document.getElementById('current-block-number');
    if (currentBlockEl) currentBlockEl.textContent = blockIndex + 1;
    if (currentBlockNumberEl) currentBlockNumberEl.textContent = blockIndex + 1;
    
    // Show first segment
    showSegment(blockIndex, 0);
}

// Segment Navigation  
function showSegment(blockIndex, segmentIndex) {
    console.log(`📖 Showing block ${blockIndex}, segment ${segmentIndex}`);
    
    // Hide all segments in this block
    const allSegments = document.querySelectorAll(`[id^="segment-${blockIndex}-"]`);
    allSegments.forEach(segment => segment.style.display = 'none');
    
    // Show current segment
    const currentSegment = document.getElementById(`segment-${blockIndex}-${segmentIndex}`);
    if (currentSegment) {
        currentSegment.style.display = 'block';
        currentSegmentIndex = segmentIndex;
        
        // Update progress bar
        const progressPercentage = ((segmentIndex + 1) / allSegments.length) * 100;
        const progressBar = document.getElementById(`segment-progress-bar-${blockIndex}`);
        if (progressBar) {
            progressBar.style.width = progressPercentage + '%';
        }
        
        // Update navigation buttons
        updateNavigationButtons(blockIndex, segmentIndex, allSegments.length);
    }
}

function nextSegment(blockIndex) {
    if (currentSegmentIndex >= 0) {
        markSegmentComplete(blockIndex, currentSegmentIndex);
    }
    const allSegments = document.querySelectorAll(`[id^="segment-${blockIndex}-"]`);
    if (currentSegmentIndex < allSegments.length - 1) {
        showSegment(blockIndex, currentSegmentIndex + 1);
    } else {
        // Move to next block
        if (blockIndex < totalBlocks - 1) {
            showBlock(blockIndex + 1);
        } else {
            alert('🎉 All blocks completed! Great work!');
        }
    }
}

function previousSegment(blockIndex) {
    if (currentSegmentIndex > 0) {
        showSegment(blockIndex, currentSegmentIndex - 1);
    } else if (blockIndex > 0) {
        // Move to previous block's last segment
        showBlock(blockIndex - 1);
        const prevSegments = document.querySelectorAll(`[id^="segment-${blockIndex - 1}-"]`);
        showSegment(blockIndex - 1, prevSegments.length - 1);
    }
}

function updateNavigationButtons(blockIndex, segmentIndex, totalSegments) {
    const prevBtn = document.getElementById(`prev-btn-${blockIndex}`);
    const nextBtn = document.getElementById(`next-btn-${blockIndex}`);
    
    if (prevBtn) {
        prevBtn.disabled = (blockIndex === 0 && segmentIndex === 0);
    }
    
    if (nextBtn) {
        if (segmentIndex === totalSegments - 1 && blockIndex === totalBlocks - 1) {
            nextBtn.innerHTML = '<i class="fas fa-check me-2"></i>Complete Study';
        } else {
            nextBtn.innerHTML = 'Next<i class="fas fa-chevron-right ms-2"></i>';
        }
    }
}

function markSegmentComplete(blockIndex, segmentIndex) {
    console.log('🎯 markSegmentComplete called:', blockIndex, segmentIndex);
    
    const segment = document.getElementById(`segment-${blockIndex}-${segmentIndex}`);
    if (segment) {
        segment.classList.add('border-success');
        
        // Get session ID from HTML element
        const sessionData = document.getElementById('session-data');
        const sessionId = sessionData ? sessionData.getAttribute('data-session-id') : null;
        
        if (sessionId) {
            fetch('/mark-segment-complete/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_id: sessionId,
                    segment_index: segmentIndex
                })
            })
            .then(response => {
                console.log('✅ Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('✅ Response data:', data);
                
                if (data.success) {
                    // Update overall progress bar
                    const progressBar = document.getElementById('sidebar-progress');
                    const progressText = document.getElementById('progress-text');
                    
                    if (progressBar) progressBar.style.width = data.progress + '%';
                    if (progressText) progressText.textContent = data.progress + '%';
                    
                    // ✅ ADD: Update segment counter
                    const completedSegmentsEl = document.getElementById('completed-segments');
                    const totalSegmentsEl = document.getElementById('total-segments');
                    
                    if (completedSegmentsEl && totalSegmentsEl) {
                        const totalSegments = parseInt(totalSegmentsEl.textContent);
                        const completedSegments = Math.round((data.progress / 100) * totalSegments);
                        completedSegmentsEl.textContent = completedSegments;
                        
                        console.log(`📊 Segments: ${completedSegments}/${totalSegments}`);
                    }
                    
                    console.log(`📈 Progress updated to ${data.progress}%`);
                } else {
                    console.log('❌ Server error:', data.error);
                }
            })
            .catch(error => console.log('❌ Error:', error));
        } else {
            console.log('❌ No session ID found');
        }
        
    }
}

function saveSegmentNote(blockIndex, segmentIndex, note) {
    if (!segmentNotes[blockIndex]) {
        segmentNotes[blockIndex] = {};
    }
    segmentNotes[blockIndex][segmentIndex] = note;
    console.log(`💾 Saved note for block ${blockIndex}, segment ${segmentIndex}`);
}

function revealAnswer(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = 'block';
    }
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (sessionTimer) clearInterval(sessionTimer);
    if (blockTimer) clearInterval(blockTimer);
});
</script>

<style>
.segment-container {
    transition: all 0.3s ease;
}

.segment-container.border-success {
    background-color: #f8fff9 !important;
}

.timer-display {
    font-family: 'Courier New', monospace;
}

.stat-item {
    padding: 0.25rem 0;
    border-bottom: 1px solid #eee;
}

.stat-item:last-child {
    border-bottom: none;
}

.progress-item {
    margin-bottom: 1rem;
}
</style>
{% endblock %}

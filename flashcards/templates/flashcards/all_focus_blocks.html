{% extends 'flashcards/base.html' %}

{% block title %}Focus Blocks - Exocortex{% endblock %}

{% block content %}
<div class="container-fluid">
    
    {% if no_blocks %}
    <!-- No Focus Blocks State -->
    <div class="row justify-content-center">
        <div class="col-md-8 text-center py-5">
            <i class="fas fa-target fa-4x text-muted mb-4"></i>
            <h3 class="text-muted">No Focus Blocks Yet</h3>
            <p class="text-muted mb-4">Upload PDFs on the home to generate AI-powered focus blocks</p>
            <a href="{% url 'flashcards:home' %}" class="btn btn-primary btn-lg">
                <i class="fas fa-upload me-2"></i>Upload Your First PDF
            </a>
        </div>
    </div>
    
    {% elif no_new_blocks %}
    <!-- No New/Overdue Blocks State -->
    <div class="row justify-content-center">
        <div class="col-lg-8 text-center">
            <div class="card shadow-sm">
                <div class="card-body py-5">
                    <i class="fas fa-check-circle fa-4x text-success mb-4"></i>
                    <h3 class="text-success mb-3">All Caught Up! üéâ</h3>
                    <p class="lead text-muted mb-4">
                        No new blocks or reviews due today. You're up to date with your learning!
                    </p>
                    
                    <div class="row text-center mb-4">
                        <div class="col-md-4">
                            <h5 class="text-primary">{{ all_blocks_count }}</h5>
                            <small class="text-muted">Total Blocks</small>
                        </div>
                        <div class="col-md-4">
                            <h5 class="text-success">{{ completed_count }}</h5>
                            <small class="text-muted">Completed</small>
                        </div>
                        <div class="col-md-4">
                            <h5 class="text-warning">0</h5>
                            <small class="text-muted">Due Today</small>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-center gap-3">
                        <a href="{% url 'flashcards:focus_schedule' %}" class="btn btn-primary">
                            <i class="fas fa-calendar-alt me-2"></i>View Schedule
                        </a>
                        <a href="{% url 'flashcards:home' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-plus me-2"></i>Add More Content
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="text-center">
                <h1 class="display-5 mb-3">
                    <i class="fas fa-target me-3"></i>Focus Blocks
                </h1>
                <p class="lead text-muted">AI-powered micro-lessons for optimal learning</p>
            </div>
        </div>
    </div>

    <!-- Study Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center bg-primary text-white">
                <div class="card-body">
                    <i class="fas fa-layer-group fa-2x mb-2"></i>
                    <h4 id="total-blocks-counter">{{ total_blocks }}</h4>
                    <p class="mb-0">Total Blocks</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h4 id="total-study-time-counter">{{ total_study_time|floatformat:0 }}m</h4>
                    <p class="mb-0">Study Time</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <i class="fas fa-file-pdf fa-2x mb-2"></i>
                    <h4>{{ unique_pdfs }}</h4>
                    <p class="mb-0">Source PDFs</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-warning text-dark">
                <div class="card-body">
                    <i class="fas fa-brain fa-2x mb-2"></i>
                    <h4>6-7min</h4>
                    <p class="mb-0">Per Block</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified Study Interface -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-play-circle me-2"></i>Interactive Study Session
                        </h5>
                        
                        <!-- ADD GLOBAL TIMER SECTION -->
                        <div class="text-center">
                            <div id="global-timer" style="font-family: monospace; font-size: 1.3rem; font-weight: bold;">
                                üïê 00:00:00
                            </div>
                            <div class="mt-1">
                                <button class="btn btn-success btn-sm" id="global-start-btn" onclick="startGlobalTimer()">
                                    <i class="fas fa-play"></i> Start Session
                                </button>
                                <button class="btn btn-warning btn-sm" id="global-pause-btn" onclick="pauseGlobalTimer()" style="display: none;">
                                    <i class="fas fa-pause"></i> Pause
                                </button>
                                <button class="btn btn-danger btn-sm" id="global-stop-btn" onclick="stopGlobalTimer()" style="display: none;">
                                    <i class="fas fa-stop"></i> End Session
                                </button>
                                <!-- ADD THIS VIEW DATA BUTTON -->
                                <button class="btn btn-info btn-sm" onclick="viewCompletions()" title="View Progress">
                                    <i class="fas fa-chart-line"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- REPLACE line 107 with better block indicator: -->
                        <div class="d-flex align-items-center">
                            <span class="badge bg-primary me-2" id="blockIndicator">Block 1</span>
                            <span class="badge bg-warning" id="currentDuration">6-7 min</span>
                            <small class="text-muted ms-2" id="blockProgress">Step 1 of 5</small>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-success" id="overallProgress" style="width: 0%"></div>
                </div>
                
                <div class="card-body">
                    <!-- Block Content Container -->
                    <div id="blockContent">
                        
                        {% for block_data in formatted_blocks %}
                        <div class="focus-block-container" 
                             data-block-index="{{ forloop.counter0 }}" 
                             data-focus-block-id="{{ block_data.block.id }}" 
                             style="display: none;">
                            
                            <!-- Block Header -->
                            <div class="block-header mb-4 p-3 bg-light rounded">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h3 class="mb-1">{{ block_data.block.title }}</h3>
                                        <p class="text-muted mb-1">
                                            <i class="fas fa-file-pdf me-1"></i>{{ block_data.source_pdf }}
                                        </p>
                                        {% if block_data.block.get_core_goal %}
                                        <p class="text-primary mb-0">
                                            <i class="fas fa-bullseye me-1"></i>{{ block_data.block.get_core_goal }}
                                        </p>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <div class="mb-2">
                                            <span class="badge bg-primary me-1">{{ block_data.total_segments }} segments</span>
                                            <span class="badge bg-warning">{{ block_data.total_qa }} Q&A</span>
                                        </div>
                                        <div class="mb-2">
                                            <span class="badge bg-info">{{ block_data.block.get_estimated_duration_display }}</span>
                                        </div>
                                        
                                        <!-- REPLACE the timer section you added with this: -->
                                        <div class="mb-2">
                                            <div class="text-center">
                                                <small class="text-muted">Block Timer</small>
                                                <div id="timer-{{ forloop.counter0 }}" style="font-family: monospace; font-size: 1.0rem; color: #28a745; font-weight: bold;">
                                                    ‚è±Ô∏è 00:00:00
                                                </div>
                                                <small class="text-muted">Auto</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step Content for this Block -->
                            <div class="step-content">
                                
                                <!-- Revision Step -->
                                {% if block_data.revision_data %}
                                <div class="study-step" style="display: none;">
                                    <div class="step-header mb-3">
                                        <h4><i class="fas fa-redo text-secondary me-2"></i>Quick Revision</h4>
                                    </div>
                                    
                                    {% if block_data.revision_data.nano_recap %}
                                    <div class="revision-content bg-light p-4 rounded mb-3">
                                        <h6>Context Reminder:</h6>
                                        <p class="mb-0">{{ block_data.revision_data.nano_recap }}</p>
                                    </div>
                                    {% endif %}
                                    
                                    {% if block_data.revision_data.question %}
                                    <div class="revision-question border-start border-primary border-4 ps-3">
                                        <h6>Quick Check:</h6>
                                        <p><strong>{{ block_data.revision_data.question.prompt }}</strong></p>
                                        <div class="mt-2">
                                            <button class="btn btn-sm btn-outline-primary" onclick="toggleAnswer('revision{{ forloop.counter0 }}')">
                                                <i class="fas fa-eye me-1"></i>Show Answer
                                            </button>
                                            <div id="revision{{ forloop.counter0 }}" class="mt-2 text-success" style="display: none;">
                                                <strong>Answer:</strong> {{ block_data.revision_data.question.answer }}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <!-- Teaching Segments -->
                                {% for segment in block_data.segments %}
                                <div class="study-step" style="display: none;">
                                    <div class="step-header mb-3">
                                        <h4><i class="fas fa-chalkboard-teacher text-success me-2"></i>{{ segment.title }}</h4>
                                        <div class="d-flex justify-content-between">
                                            <p class="text-muted mb-0">Segment {{ forloop.counter }}</p>
                                            <span class="badge bg-primary">{{ segment.time_sec }}s</span>
                                        </div>
                                    </div>
                                    
                                    {% if segment.teach %}
                                    <div class="teaching-content">
                                        {% for step in segment.teach %}
                                        <div class="teaching-step mb-3 p-3 rounded border-start border-4 
                                             {% if step.mode == 'socratic' %}border-info bg-light-blue
                                             {% elif step.mode == 'example' %}border-success bg-light-green
                                             {% elif step.mode == 'warning' %}border-warning bg-light-warning
                                             {% else %}border-secondary bg-light{% endif %}">
                                            
                                            <div class="d-flex align-items-start">
                                                <span class="badge 
                                                      {% if step.mode == 'socratic' %}bg-info
                                                      {% elif step.mode == 'example' %}bg-success
                                                      {% elif step.mode == 'warning' %}bg-warning
                                                      {% else %}bg-secondary{% endif %} me-3">
                                                    {{ step.mode|title }}
                                                </span>
                                                <div class="flex-grow-1">
                                                    <p class="mb-0">{{ step.text }}</p>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}

                                <!-- Q&A Steps -->
                                {% for qa in block_data.qa_items %}
                                <div class="study-step" style="display: none;">
                                    <div class="step-header mb-3">
                                        <h4><i class="fas fa-question-circle text-warning me-2"></i>Knowledge Check {{ forloop.counter }}</h4>
                                    </div>
                                    
                                    <div class="qa-interactive">
                                        <div class="question-card bg-primary text-white p-4 rounded mb-3">
                                            <h5>{{ qa.prompt }}</h5>
                                            <span class="badge bg-light text-primary">{{ qa.type|title }} Question</span>
                                        </div>
                                        
                                        <div class="text-center mb-3">
                                            <button class="btn btn-success btn-lg" onclick="revealAnswer('qa{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}')">
                                                <i class="fas fa-eye me-2"></i>Reveal Answer
                                            </button>
                                        </div>
                                        
                                        <div id="qa{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" class="answer-section" style="display: none;">
                                            <div class="answer-card bg-success text-white p-4 rounded mb-3">
                                                <h6><i class="fas fa-check-circle me-2"></i>Ideal Answer:</h6>
                                                <p class="mb-0">{{ qa.ideal_answer }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}

                                <!-- Recap Step -->
                                {% if block_data.recap_data %}
                                <div class="study-step" style="display: none;">
                                    <div class="step-header mb-3">
                                        <h4><i class="fas fa-flag-checkered text-success me-2"></i>Block Complete!</h4>
                                    </div>
                                    
                                    {% if block_data.recap_data.bullets %}
                                    <div class="recap-content bg-success text-white p-4 rounded mb-4">
                                        <h5><i class="fas fa-check-circle me-2"></i>Key Takeaways:</h5>
                                        <ul class="mb-0">
                                            {% for bullet in block_data.recap_data.bullets %}
                                            <li>{{ bullet }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}

                            </div>
                        </div>
                        {% endfor %}

                    </div>
                </div>
                
                <!-- Navigation Footer -->
                <div class="card-footer bg-light">
                    <!-- Mobile-friendly navigation -->
                    <div class="row align-items-center">
                        <div class="col-3">
                            <button class="btn btn-outline-secondary btn-lg w-100" id="prevBtn" onclick="previousStep()" disabled>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        </div>
                        <div class="col-6 text-center">
                            <!-- Visual progress for current block -->
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar" id="blockProgressBar" style="width: 20%"></div>
                            </div>
                            <small class="text-muted" id="stepInfo">Revision ‚Ä¢ 1/5</small>
                        </div>
                        <div class="col-3">
                            <button class="btn btn-primary btn-lg w-100" id="nextBtn" onclick="nextStep()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Swipe hint -->
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            <i class="fas fa-hand-point-right me-1"></i>Swipe or tap to navigate
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ADD THIS COMPLETION MODAL before the closing container div -->

<!-- Focus Block Completion Modal -->
<div class="modal fade" id="completionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Focus Block Complete!
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <h6>Block: <span id="completed-block-title"></span></h6>
                    <p class="text-muted">Time: <span id="completed-block-time"></span></p>
                </div>
                
                <div class="mb-4">
                    <label class="form-label h6">How well did you understand this content?</label>
                    <div class="rating-scale d-flex justify-content-center gap-2 mt-2">
                        <input type="radio" class="btn-check" name="proficiency" id="prof1" value="1">
                        <label class="btn btn-outline-danger" for="prof1">1<br><small>Poor</small></label>
                        
                        <input type="radio" class="btn-check" name="proficiency" id="prof2" value="2">
                        <label class="btn btn-outline-warning" for="prof2">2<br><small>Basic</small></label>
                        
                        <input type="radio" class="btn-check" name="proficiency" id="prof3" value="3">
                        <label class="btn btn-outline-info" for="prof3">3<br><small>Good</small></label>
                        
                        <input type="radio" class="btn-check" name="proficiency" id="prof4" value="4">
                        <label class="btn btn-outline-primary" for="prof4">4<br><small>Strong</small></label>
                        
                        <input type="radio" class="btn-check" name="proficiency" id="prof5" value="5">
                        <label class="btn btn-outline-success" for="prof5">5<br><small>Mastered</small></label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="saveCompletion()" id="save-completion-btn" disabled>
                    <i class="fas fa-save me-2"></i>Save & Continue
                </button>
            </div>
        </div>
    </div>
</div>
    
    {% endif %}
</div>

<script>
    // ‚úÖ Pass completion data from Django to JavaScript
    window.serverCompletions = {{ completion_data_json|safe }};
    console.log('üìä Server completion data loaded:', window.serverCompletions);
</script>

<script>
console.log('üß™ BASIC TEST: JavaScript is loading...');

// Simple test function
function testSync() {
    console.log('üß™ TEST: Function can run');
    
    fetch('/api/focus-completions/')
    .then(response => response.json())
    .then(data => {
        console.log('üß™ TEST: API response:', data);
        if (data.success && data.completions.length > 0) {
            console.log(`üß™ TEST: Found ${data.completions.length} completions`);
            // alert(`Found ${data.completions.length} completions in database!`); // REMOVED
        } else {
            console.log('üß™ TEST: No completions found');
        }
    })
    .catch(error => {
        console.log('üß™ TEST: API error:', error);
    });
}

// Run test immediately
console.log('üß™ RUNNING TEST...');
testSync();

// ‚úÖ ESSENTIAL FUNCTIONS FOR BUTTON FUNCTIONALITY

// Global variables
// Global variables
let currentGlobalStepIndex = 0;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Page loaded, initializing...');
    showStep(0); // Start with first step
    
    // Count total steps for debugging
    const totalSteps = document.querySelectorAll('.study-step').length;
    console.log('üìä Total study steps found:', totalSteps);
    
    // ‚úÖ DISABLE navigation until session starts
    disableNavigationButtons();
});
let globalTimer = 0;
let globalTimerInterval = null;
let globalTimerRunning = false;
let timers = {};
let timerIntervals = {};
let currentActiveTimer = null;

// Navigation functions - BLOCKED until study session starts
function nextStep() {
    // ‚úÖ HARD BLOCK: Prevent navigation without active study session
    if (!globalTimerRunning) {
        showSessionRequiredToast();
        return; // Stop execution completely
    }
    
    // Check if current block is completed BEFORE moving to next step
    const isBlockCompleted = checkBlockCompletion(currentGlobalStepIndex);
    
    if (!isBlockCompleted) {
        // Normal step progression within the same block
        currentGlobalStepIndex++;
        showStep(currentGlobalStepIndex);
        updateButtonStates(); // Update button states after navigation
    }
    // If block is completed, the modal will handle progression via moveToNextBlock()
}

function previousStep() {
    // ‚úÖ HARD BLOCK: Prevent navigation without active study session
    if (!globalTimerRunning) {
        showSessionRequiredToast();
        return; // Stop execution completely
    }
    
    if (currentGlobalStepIndex > 0) {
        currentGlobalStepIndex--;
        showStep(currentGlobalStepIndex);
        updateButtonStates(); // Update button states after navigation
    }
}

function showStep(stepIndex) {
    console.log('üîç showStep called with index:', stepIndex);
    
    // Hide all focus block containers first
    const allContainers = document.querySelectorAll('.focus-block-container');
    allContainers.forEach(container => container.style.display = 'none');
    
    // Hide all study steps
    const allSteps = document.querySelectorAll('.study-step');
    allSteps.forEach(el => el.style.display = 'none');
    
    console.log('üìä Total steps found:', allSteps.length);
    console.log('üìä Total containers found:', allContainers.length);
    
    // Show current step AND its parent container
    if (allSteps[stepIndex]) {
        // Find the parent focus-block-container
        const currentStep = allSteps[stepIndex];
        const parentContainer = currentStep.closest('.focus-block-container');
        
        if (parentContainer) {
            parentContainer.style.display = 'block';
            console.log('‚úÖ Showing parent container');
        }
        
        // Show the step itself
        currentStep.style.display = 'block';
        console.log('‚úÖ Showing step', stepIndex);
    } else {
        console.log('‚ùå Step', stepIndex, 'not found');
    }
    
    // Update buttons
    document.getElementById('prevBtn').disabled = stepIndex === 0;
    document.getElementById('nextBtn').disabled = stepIndex >= allSteps.length - 1;
    
    // Update progress indicator
    const stepInfo = document.getElementById('stepInfo');
    if (stepInfo) {
        stepInfo.textContent = `Step ${stepIndex + 1} of ${allSteps.length}`;
    }
    
    // Update progress bar
    const progressBar = document.getElementById('overallProgress');
    if (progressBar && allSteps.length > 0) {
        const progress = ((stepIndex + 1) / allSteps.length) * 100;
        progressBar.style.width = `${progress}%`;
    }

    // ‚úÖ ADD: Start block timer when switching focus blocks
    const currentBlockIndex = getCurrentBlockIndex(stepIndex);
    if (globalTimerRunning && currentActiveTimer !== currentBlockIndex) {
        startBlockTimer(currentBlockIndex);
    }
}

// Timer functions
function startGlobalTimer() {
    if (!globalTimerRunning) {
        globalTimerInterval = setInterval(() => {
            globalTimer++;
            updateGlobalTimerDisplay();
        }, 1000);
        globalTimerRunning = true;
        
        // ‚úÖ ADD: Start the current block timer
        const currentBlockIndex = getCurrentBlockIndex(currentGlobalStepIndex);
        startBlockTimer(currentBlockIndex);
        
        // Update button visibility
        document.getElementById('global-start-btn').style.display = 'none';
        document.getElementById('global-pause-btn').style.display = 'inline-block';
        document.getElementById('global-stop-btn').style.display = 'inline-block';
        enableNavigationButtons(); // ‚úÖ ADD THIS LINE
    }
}

function pauseGlobalTimer() {
    clearInterval(globalTimerInterval);
    globalTimerRunning = false;
    disableNavigationButtons(); // ‚úÖ LOCK navigation when paused
    
    document.getElementById('global-start-btn').style.display = 'inline-block';
    document.getElementById('global-pause-btn').style.display = 'none';
}

function stopGlobalTimer() {
    clearInterval(globalTimerInterval);
    globalTimerRunning = false;
    globalTimer = 0;
    updateGlobalTimerDisplay();
    disableNavigationButtons(); // ‚úÖ LOCK navigation when stopped
    
    document.getElementById('global-start-btn').style.display = 'inline-block';
    document.getElementById('global-pause-btn').style.display = 'none';
    document.getElementById('global-stop-btn').style.display = 'none';
}

function updateGlobalTimerDisplay() {
    const hours = Math.floor(globalTimer / 3600);
    const minutes = Math.floor((globalTimer % 3600) / 60);
    const seconds = globalTimer % 60;
    const timeStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    const timerEl = document.getElementById('global-timer');
    if (timerEl) {
        timerEl.textContent = `üïê ${timeStr}`;
    }
}

// Answer reveal functions
function toggleAnswer(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = element.style.display === 'none' ? 'block' : 'none';
    }
}

function revealAnswer(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = 'block';
    }
}

// Completion function
function saveCompletion() {
    alert('Completion saved! (Basic version)');
    nextStep();
}

// Progress viewer
function viewCompletions() {
    alert('Progress: Basic functionality restored!');
}

// Block Timer Functions
function startBlockTimer(blockIndex) {
    console.log('üü¢ Starting block timer for block:', blockIndex);
    
    // Stop any currently running block timer
    if (currentActiveTimer !== null) {
        stopBlockTimer(currentActiveTimer);
    }
    
    // Initialize timer for this block if it doesn't exist
    if (!timers[blockIndex]) {
        timers[blockIndex] = 0;
    }
    
    // Start interval for this block
    timerIntervals[blockIndex] = setInterval(() => {
        timers[blockIndex]++;
        updateBlockTimerDisplay(blockIndex);
    }, 1000);
    
    currentActiveTimer = blockIndex;
    updateBlockTimerDisplay(blockIndex);
}

function stopBlockTimer(blockIndex) {
    console.log('üî¥ Stopping block timer for block:', blockIndex);
    
    if (timerIntervals[blockIndex]) {
        clearInterval(timerIntervals[blockIndex]);
        delete timerIntervals[blockIndex];
    }
    
    if (currentActiveTimer === blockIndex) {
        currentActiveTimer = null;
    }
}

function updateBlockTimerDisplay(blockIndex) {
    const timerElement = document.getElementById(`timer-${blockIndex}`);
    if (timerElement && timers[blockIndex] !== undefined) {
        const timeStr = formatTime(timers[blockIndex]);
        timerElement.textContent = `‚è±Ô∏è ${timeStr}`;
    }
}

function formatTime(totalSeconds) {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function getCurrentBlockIndex(stepIndex) {
    // Find which focus block contains this step
    const allSteps = document.querySelectorAll('.study-step');
    if (allSteps[stepIndex]) {
        const currentStep = allSteps[stepIndex];
        const parentContainer = currentStep.closest('.focus-block-container');
        if (parentContainer) {
            return parseInt(parentContainer.dataset.blockIndex);
        }
    }
    return 0;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Page loaded, initializing...');
    showStep(0); // Start with first step
    
    // Count total steps for debugging
    const totalSteps = document.querySelectorAll('.study-step').length;
    console.log('üìä Total study steps found:', totalSteps);
});

// ‚úÖ FIXED COMPLETION SYSTEM - Prevents Repeated Modals

// Variables for completion tracking
let currentCompletingBlock = null;
let completedBlocks = new Set();  // Track which blocks are already completed
let blockStartTimes = {};

// Detect when a focus block is completed
function checkBlockCompletion(stepIndex) {
    const currentBlockIndex = getCurrentBlockIndex(stepIndex);
    
    // ‚úÖ PREVENT REPEATED MODALS: Check if block already completed
    if (completedBlocks.has(currentBlockIndex)) {
        console.log(`‚è≠Ô∏è Block ${currentBlockIndex} already completed, skipping modal`);
        return false;
    }
    
    const allSteps = document.querySelectorAll('.study-step');
    
    // Get all steps for the current block
    const currentBlockSteps = Array.from(allSteps).filter(step => {
        const container = step.closest('.focus-block-container');
        return container && parseInt(container.dataset.blockIndex) === currentBlockIndex;
    });
    
    // Find current step within this block
    const currentStep = allSteps[stepIndex];
    const stepIndexInBlock = currentBlockSteps.indexOf(currentStep);
    
    console.log(`üìä Block ${currentBlockIndex}: Step ${stepIndexInBlock + 1}/${currentBlockSteps.length}`);
    
    // If this is the last step of the block, check if study session is active
    if (stepIndexInBlock === currentBlockSteps.length - 1) {
        
        // ‚úÖ GUARD: Prevent completion without active study session
        if (!globalTimerRunning) {
            console.log('‚ö†Ô∏è Block completion attempted without active study session');
            showToast('‚ö†Ô∏è Please start the study session first!', 'warning');
            return false;
        }
        
        const blockTime = timers[currentBlockIndex] || 0;
        
        // ‚úÖ GUARD: Prevent completion with zero time
        if (blockTime === 0) {
            console.log('‚ö†Ô∏è Block completion attempted with zero study time');
            showToast('‚ö†Ô∏è Please study the content before marking as complete!', 'warning');
            return false;
        }
        
        console.log('üéâ Block completed! Showing modal...');
        showCompletionModal(currentBlockIndex, blockTime);
        return true;
    }
    
    return false;
}

function showCompletionModal(blockIndex, completionTime) {
    console.log('üèÜ Showing completion modal for block:', blockIndex, 'Time:', completionTime);
    
    // ‚úÖ DEBUG: Check what's happening with focus block ID
    console.log('üîç FOCUS BLOCK ID DEBUG:');
    console.log('   blockIndex:', blockIndex);
    console.log('   querySelector:', `[data-block-index="${blockIndex}"]`);

    const container = document.querySelector(`[data-block-index="${blockIndex}"]`);
    console.log('   container found:', !!container);

    if (container) {
        console.log('   data-block-index:', container.dataset.blockIndex);
        console.log('   data-focus-block-id:', container.dataset.focusBlockId);
    } else {
        console.log('   ‚ùå Container not found!');
        console.log('   Available containers:');
        document.querySelectorAll('[data-block-index]').forEach(el => {
            console.log(`      - data-block-index="${el.dataset.blockIndex}" id="${el.dataset.focusBlockId?.substr(0,8)}..."`);
        });
    }

    const focusBlockId = container ? container.dataset.focusBlockId : null;
    console.log('   Final focusBlockId:', focusBlockId);
    console.log('---');
    
    // ‚úÖ MARK BLOCK AS COMPLETED to prevent repeated modals
    completedBlocks.add(blockIndex);
    
    // Get focus block ID immediately when modal opens
    const container = document.querySelector(`[data-block-index="${blockIndex}"]`);
    const focusBlockId = container ? container.dataset.focusBlockId : null;
    
    console.log('üîç Storing focusBlockId:', focusBlockId);
    
    // Store completion data INCLUDING focusBlockId
    currentCompletingBlock = {
        blockIndex: blockIndex,
        completionTime: completionTime,
        focusBlockId: focusBlockId,  // ‚úÖ Store immediately
        timestamp: new Date().toISOString()
    };
    
    // Get block title
    const blockTitle = container ? container.querySelector('h3').textContent : `Block ${blockIndex + 1}`;
    
    // Update modal content
    document.getElementById('completed-block-title').textContent = blockTitle;
    document.getElementById('completed-block-time').textContent = formatTime(completionTime);
    
    // Reset rating selection
    document.querySelectorAll('input[name="proficiency"]').forEach(radio => {
        radio.checked = false;
    });
    document.getElementById('save-completion-btn').disabled = true;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('completionModal'));
    modal.show();
}

// Enhanced saveCompletion function
async function saveCompletion() {
    console.log('üíæ Saving completion...');
    
    const selectedRating = document.querySelector('input[name="proficiency"]:checked');
    if (!selectedRating) {
        alert('Please select a proficiency rating first!');
        return;
    }
    
    const proficiencyScore = parseInt(selectedRating.value);
    const completionTime = currentCompletingBlock.completionTime;
    const blockIndex = currentCompletingBlock.blockIndex;
    
    console.log('üìä Completion data:', { proficiencyScore, completionTime, blockIndex });
    
    // ‚úÖ Use stored focusBlockId instead of re-querying DOM
    const focusBlockId = currentCompletingBlock.focusBlockId;
    
    console.log('üíæ Using stored focusBlockId:', focusBlockId);
    
    if (focusBlockId) {
        try {
            const response = await fetch(`/api/focus-block/${focusBlockId}/complete/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    proficiency_score: proficiencyScore,
                    completion_time: completionTime
                }),
                signal: AbortSignal.timeout(15000)  // 15 second timeout
            });
            
            // ‚úÖ Check HTTP status first
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            // ‚úÖ Safe JSON parsing
            const result = await response.json();
            
            if (result.success) {
                console.log('‚úÖ Saved to database:', result);
                showToast(`‚úÖ Block completed! Rating: ${proficiencyScore}/5 ‚≠ê`, 'success');
                
                // ‚úÖ UPDATE COUNTERS DYNAMICALLY
                updateStatsAfterCompletion(completionTime);
            } else {
                throw new Error(result.error || 'Server returned failure');
            }
            
        } catch (error) {
            console.error('‚ùå Database save failed:', error);
            
            // ‚úÖ Better error categorization
            if (error.name === 'AbortError') {
                showToast('‚è≥ Request timeout - saved locally', 'warning');
            } else if (error.message.includes('HTTP 500')) {
                showToast('üö® Server error - saved locally', 'warning');
            } else if (error.message.includes('HTTP 4')) {
                showToast('‚ùå Request error - saved locally', 'warning');
            } else {
                showToast('‚ö†Ô∏è Network error - saved locally', 'warning');
            }
        }
    } else {
        console.error('‚ùå No focusBlockId stored - cannot save to database');
        showToast('‚ö†Ô∏è Cannot identify block - saved locally only', 'warning');
    }
    
    // Save to localStorage as backup
    saveToLocalStorage(blockIndex, proficiencyScore, completionTime);
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('completionModal'));
    if (modal) {
        modal.hide();
    }
    
    // ‚úÖ PROPER PROGRESSION: Move to next block's first step
    setTimeout(() => {
        moveToNextBlock();
    }, 2000);  // Brief delay for better UX
}

function moveToNextBlock() {
    const allSteps = document.querySelectorAll('.study-step');
    const currentBlockIndex = getCurrentBlockIndex(currentGlobalStepIndex);
    
    // Find the first step of the next block
    for (let i = currentGlobalStepIndex + 1; i < allSteps.length; i++) {
        const nextBlockIndex = getCurrentBlockIndex(i);
        if (nextBlockIndex !== currentBlockIndex) {
            // Found next block, go to its first step
            console.log(`‚è≠Ô∏è Moving from block ${currentBlockIndex} to block ${nextBlockIndex}`);
            currentGlobalStepIndex = i;
            showStep(currentGlobalStepIndex);
            return;
        }
    }
    
    // No more blocks, show completion message
    console.log('üéâ All blocks completed!');
    showToast('üéâ Congratulations! All focus blocks completed!', 'success');
}

function saveToLocalStorage(blockIndex, proficiencyScore, completionTime) {
    const completions = JSON.parse(localStorage.getItem('focusBlockCompletions') || '[]');
    
    const completion = {
        blockIndex: blockIndex,
        proficiencyRating: proficiencyScore,
        completionTime: completionTime,
        completedAt: new Date().toISOString()
    };
    
    completions.push(completion);
    localStorage.setItem('focusBlockCompletions', JSON.stringify(completions));
    console.log('üíæ Saved to localStorage:', completion);
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `position-fixed top-0 start-50 translate-middle-x alert alert-${type === 'success' ? 'success' : 'warning'} alert-dismissible mt-3`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div>${message}</div>
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 4000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Enable save button when rating is selected
document.addEventListener('change', function(e) {
    if (e.target.name === 'proficiency') {
        document.getElementById('save-completion-btn').disabled = false;
    }
});

// Show user guidance for starting study session
function showStudySessionPrompt() {
    if (!globalTimerRunning) {
        const startBtn = document.getElementById('global-start-btn');
        if (startBtn && startBtn.style.display !== 'none') {
            // Add visual emphasis to start button
            startBtn.classList.add('btn-pulse');
            startBtn.innerHTML = '<i class="fas fa-play"></i> Start Session First!';
            
            setTimeout(() => {
                startBtn.classList.remove('btn-pulse');
                startBtn.innerHTML = '<i class="fas fa-play"></i> Start Session';
            }, 3000);
        }
    }
}

// Button state management
function disableNavigationButtons() {
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    
    if (nextBtn) {
        nextBtn.disabled = true;
        nextBtn.classList.add('btn-disabled');
        nextBtn.innerHTML = '<i class="fas fa-lock"></i> Start Session to Navigate';
        nextBtn.title = 'Please start the study session first';
    }
    
    if (prevBtn) {
        prevBtn.disabled = true;
        prevBtn.classList.add('btn-disabled');
    }
    
    console.log('üö´ Navigation buttons DISABLED');
}

function enableNavigationButtons() {
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    
    if (nextBtn) {
        nextBtn.disabled = false;
        nextBtn.classList.remove('btn-disabled');
        nextBtn.innerHTML = '<i class="fas fa-arrow-right"></i> Next';
        nextBtn.title = 'Go to next step';
    }
    
    if (prevBtn) {
        prevBtn.disabled = false;
        prevBtn.classList.remove('btn-disabled');
    }
    
    console.log('‚úÖ Navigation buttons ENABLED');
    updateButtonStates(); // Set correct initial states
}

function updateButtonStates() {
    // Only update if navigation is enabled (session running)
    if (!globalTimerRunning) return;
    
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const totalSteps = document.querySelectorAll('.study-step').length;
    
    // Previous button
    if (prevBtn) {
        prevBtn.disabled = (currentGlobalStepIndex === 0);
    }
    
    // Next button  
    if (nextBtn) {
        if (currentGlobalStepIndex >= totalSteps - 1) {
            nextBtn.innerHTML = '<i class="fas fa-flag-checkered"></i> Complete Study';
        } else {
            nextBtn.innerHTML = '<i class="fas fa-arrow-right"></i> Next';
        }
    }
}

function showSessionRequiredToast() {
    showToast('üîí Please start the study session first!', 'warning');
    
    // Highlight the start button
    const startBtn = document.getElementById('global-start-btn');
    if (startBtn && startBtn.style.display !== 'none') {
        startBtn.classList.add('btn-pulse');
        setTimeout(() => startBtn.classList.remove('btn-pulse'), 2000);
    }
}

// ‚úÖ DYNAMIC COUNTER UPDATES
function updateStatsAfterCompletion(completionTime) {
    // Update total blocks (decrease by 1)
    const totalBlocksEl = document.getElementById('total-blocks-counter');
    if (totalBlocksEl) {
        const currentCount = parseInt(totalBlocksEl.textContent);
        const newCount = Math.max(0, currentCount - 1);
        totalBlocksEl.textContent = newCount;
        
        console.log(`üìä Updated total blocks: ${currentCount} ‚Üí ${newCount}`);
    }
    
    // Update total study time (add completion time)
    const totalTimeEl = document.getElementById('total-study-time-counter');
    if (totalTimeEl) {
        const currentTimeText = totalTimeEl.textContent.replace('m', '');
        const currentTime = parseInt(currentTimeText) || 0;
        const additionalMinutes = Math.round(completionTime / 60);
        const newTime = currentTime + additionalMinutes;
        totalTimeEl.textContent = `${newTime}m`;
        
        console.log(`‚è±Ô∏è Updated study time: ${currentTime}m ‚Üí ${newTime}m`);
    }
    
    // Check if no blocks remaining
    const remainingBlocks = parseInt(totalBlocksEl?.textContent || '0');
    if (remainingBlocks === 0) {
        setTimeout(() => {
            showToast('üéâ All blocks completed! Great job!', 'success');
        }, 1000);
    }
}
</script>

</div>
{% endblock %}

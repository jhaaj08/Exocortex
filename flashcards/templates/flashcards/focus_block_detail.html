{% extends 'flashcards/base.html' %}

{% block title %}{{ focus_block.title }} - Focus Block Study{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'flashcards:home' %}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'flashcards:pdf_focus_blocks' pdf_document.id %}">Focus Blocks</a></li>
                    <li class="breadcrumb-item active">{{ focus_block.title }}</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-target me-2"></i>{{ focus_block.title }}</h1>
                    <p class="text-muted mb-0">
                        <i class="fas fa-file-pdf me-1"></i>{{ pdf_document.name }} - Block {{ focus_block.block_order }}
                    </p>
                </div>
                <div>
                    <a href="{% url 'flashcards:pdf_focus_blocks' pdf_document.id %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to All Blocks
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Study Progress Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-play-circle me-2"></i>Interactive Study Session
                        </h5>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-light text-primary me-2" id="stepIndicator">1 / 1</span>
                            <span class="badge bg-warning">{{ focus_block.get_estimated_duration_display }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="progress" style="height: 4px;">
                    <div class="progress-bar bg-success" id="progressBar" style="width: 0%"></div>
                </div>
                
                <div class="card-body">
                    <!-- Learning Goal -->
                    {% if focus_block.get_core_goal %}
                    <div class="alert alert-info mb-4">
                        <h6><i class="fas fa-bullseye me-2"></i>Learning Goal</h6>
                        <p class="mb-0">{{ focus_block.get_core_goal }}</p>
                    </div>
                    {% endif %}

                    <!-- Step Content Container -->
                    <div id="stepContent" style="min-height: 300px;">
                        
                        <!-- Revision Step (if exists) -->
                        {% if focus_block.get_revision_data %}
                        <div class="study-step" data-step-type="revision" style="display: none;">
                            <div class="step-header mb-3">
                                <h4><i class="fas fa-redo text-secondary me-2"></i>Quick Revision</h4>
                                <p class="text-muted">Let's start by reviewing related concepts</p>
                            </div>
                            
                            {% with revision_data=focus_block.get_revision_data %}
                            {% if revision_data.nano_recap %}
                            <div class="revision-content bg-light p-4 rounded mb-3">
                                <h6>Context Reminder:</h6>
                                <p class="mb-0">{{ revision_data.nano_recap }}</p>
                            </div>
                            {% endif %}
                            
                            {% if revision_data.question %}
                            <div class="revision-question border-start border-primary border-4 ps-3">
                                <h6>Quick Check:</h6>
                                <p><strong>{{ revision_data.question.prompt }}</strong></p>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="toggleAnswer('revisionAnswer')">
                                        <i class="fas fa-eye me-1"></i>Show Answer
                                    </button>
                                    <div id="revisionAnswer" class="mt-2 text-success" style="display: none;">
                                        <strong>Answer:</strong> {{ revision_data.question.answer }}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endwith %}
                        </div>
                        {% endif %}

                        <!-- Teaching Segments -->
                        {% for segment in focus_block.get_segments %}
                        <div class="study-step" data-step-type="segment" style="display: none;">
                            <div class="step-header mb-3">
                                <h4>
                                    <i class="fas fa-chalkboard-teacher text-success me-2"></i>
                                    {{ segment.title }}
                                </h4>
                                <div class="d-flex justify-content-between align-items-center">
                                    <p class="text-muted mb-0">Teaching segment {{ forloop.counter }}</p>
                                    <span class="badge bg-primary">{{ segment.time_sec }}s</span>
                                </div>
                            </div>
                            
                            {% if segment.teach %}
                            <div class="teaching-content">
                                {% for step in segment.teach %}
                                <div class="teaching-step mb-3 p-3 rounded border-start border-4 
                                     {% if step.mode == 'socratic' %}border-info bg-light-blue
                                     {% elif step.mode == 'example' %}border-success bg-light-green
                                     {% elif step.mode == 'warning' %}border-warning bg-light-warning
                                     {% elif step.mode == 'benefit' %}border-primary bg-light
                                     {% else %}border-secondary bg-light{% endif %}">
                                    
                                    <div class="d-flex align-items-start">
                                        <span class="badge 
                                              {% if step.mode == 'socratic' %}bg-info
                                              {% elif step.mode == 'example' %}bg-success
                                              {% elif step.mode == 'warning' %}bg-warning
                                              {% elif step.mode == 'benefit' %}bg-primary
                                              {% else %}bg-secondary{% endif %} me-3">
                                            {% if step.mode == 'socratic' %}<i class="fas fa-question-circle"></i>
                                            {% elif step.mode == 'example' %}<i class="fas fa-lightbulb"></i>
                                            {% elif step.mode == 'warning' %}<i class="fas fa-exclamation-triangle"></i>
                                            {% elif step.mode == 'benefit' %}<i class="fas fa-star"></i>
                                            {% else %}<i class="fas fa-info"></i>{% endif %}
                                            {{ step.mode|title }}
                                        </span>
                                        <div class="flex-grow-1">
                                            <p class="mb-0">{{ step.text }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            {% if segment.diagram_suggestion %}
                            <div class="alert alert-info mt-3">
                                <h6><i class="fas fa-chart-bar me-2"></i>Visual Aid Suggestion</h6>
                                <p class="mb-0">{{ segment.diagram_suggestion }}</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}

                        <!-- Q&A Steps -->
                        {% for qa in qa_items %}
                        <div class="study-step" data-step-type="qa" style="display: none;">
                            <div class="step-header mb-3">
                                <h4><i class="fas fa-question-circle text-warning me-2"></i>Knowledge Check {{ forloop.counter }}</h4>
                                <p class="text-muted">Test your understanding</p>
                            </div>
                            
                            <div class="qa-interactive">
                                <div class="question-card bg-primary text-white p-4 rounded mb-3">
                                    <h5>{{ qa.prompt }}</h5>
                                    <span class="badge bg-light text-primary">{{ qa.type|title }} Question</span>
                                </div>
                                
                                <div class="text-center mb-3">
                                    <button class="btn btn-success btn-lg" onclick="revealAnswer('qa{{ forloop.counter }}')">
                                        <i class="fas fa-eye me-2"></i>Reveal Answer
                                    </button>
                                </div>
                                
                                <div id="qa{{ forloop.counter }}" class="answer-section" style="display: none;">
                                    <div class="answer-card bg-success text-white p-4 rounded mb-3">
                                        <h6><i class="fas fa-check-circle me-2"></i>Ideal Answer:</h6>
                                        <p class="mb-0">{{ qa.ideal_answer }}</p>
                                    </div>
                                    
                                    {% if qa.rubric %}
                                    <div class="rubric-section bg-light p-3 rounded">
                                        <h6>Key Points to Include:</h6>
                                        <ul class="mb-0">
                                            {% for point in qa.rubric %}
                                            <li>{{ point }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                        <!-- Recap Step -->
                        {% if focus_block.get_recap_data %}
                        <div class="study-step" data-step-type="recap" style="display: none;">
                            <div class="step-header mb-3">
                                <h4><i class="fas fa-flag-checkered text-success me-2"></i>Session Complete!</h4>
                                <p class="text-muted">Let's wrap up what you've learned</p>
                            </div>
                            
                            {% with recap_data=focus_block.get_recap_data %}
                            {% if recap_data.bullets %}
                            <div class="recap-content bg-success text-white p-4 rounded mb-4">
                                <h5><i class="fas fa-check-circle me-2"></i>Key Takeaways:</h5>
                                <ul class="mb-0">
                                    {% for bullet in recap_data.bullets %}
                                    <li>{{ bullet }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            
                            {% if recap_data.confidence_prompt %}
                            <div class="confidence-check bg-light p-4 rounded mb-3">
                                <h6>{{ recap_data.confidence_prompt }}</h6>
                                <div class="confidence-slider mt-3">
                                    <input type="range" class="form-range" min="1" max="5" value="3" id="confidenceSlider">
                                    <div class="d-flex justify-content-between">
                                        <small>Not confident</small>
                                        <small>Very confident</small>
                                    </div>
                                    <div class="text-center mt-2">
                                        <span class="badge bg-primary" id="confidenceValue">3</span>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="completion-actions text-center">
                                <button class="btn btn-success btn-lg me-3" onclick="completeSession()">
                                    <i class="fas fa-trophy me-2"></i>Complete Session
                                </button>
                                <a href="{% url 'flashcards:pdf_focus_blocks' pdf_document.id %}" class="btn btn-outline-primary">
                                    <i class="fas fa-list me-2"></i>Next Focus Block
                                </a>
                            </div>
                            {% endwith %}
                        </div>
                        {% endif %}

                    </div>
                </div>
                
                <!-- Navigation Footer -->
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <button class="btn btn-outline-secondary" id="prevBtn" onclick="previousStep()" disabled>
                            <i class="fas fa-chevron-left me-1"></i>Previous
                        </button>
                        
                        <div class="step-dots" id="stepDots">
                            <!-- Dynamic dots will be inserted here -->
                        </div>
                        
                        <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                            Next <i class="fas fa-chevron-right ms-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Stepper Navigation Logic
let currentStep = 0;
let totalSteps = 0;
const steps = document.querySelectorAll('.study-step');

// Initialize stepper
function initializeStepper() {
    // Auto-number all steps
    steps.forEach((step, index) => {
        step.setAttribute('data-step', index);
    });
    
    totalSteps = steps.length;
    console.log(`Found ${totalSteps} steps`);
    
    // Create step dots
    const dotsContainer = document.getElementById('stepDots');
    dotsContainer.innerHTML = ''; // Clear existing dots
    
    for (let i = 0; i < totalSteps; i++) {
        const dot = document.createElement('span');
        dot.className = 'step-dot';
        dot.onclick = () => goToStep(i);
        dotsContainer.appendChild(dot);
    }
    
    // Show first step
    if (totalSteps > 0) {
        showStep(0);
    }
}

// Show specific step
function showStep(stepIndex) {
    // Validate step index
    if (stepIndex < 0 || stepIndex >= totalSteps) {
        console.log(`Invalid step index: ${stepIndex}`);
        return;
    }
    
    // Hide all steps
    steps.forEach(step => step.style.display = 'none');
    
    // Show current step
    steps[stepIndex].style.display = 'block';
    currentStep = stepIndex;
    
    // Update UI
    updateStepIndicator();
    updateProgressBar();
    updateNavigationButtons();
    updateStepDots();
    
    // Scroll to top of content
    document.getElementById('stepContent').scrollIntoView({ behavior: 'smooth' });
    
    console.log(`Showing step ${stepIndex + 1} of ${totalSteps}`);
}

// Navigation functions
function nextStep() {
    if (currentStep < totalSteps - 1) {
        showStep(currentStep + 1);
    }
}

function previousStep() {
    if (currentStep > 0) {
        showStep(currentStep - 1);
    }
}

function goToStep(stepIndex) {
    showStep(stepIndex);
}

// UI Updates
function updateStepIndicator() {
    document.getElementById('stepIndicator').textContent = `${currentStep + 1} / ${totalSteps}`;
}

function updateProgressBar() {
    const progress = ((currentStep + 1) / totalSteps) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    prevBtn.disabled = currentStep === 0;
    
    // Update next button for last step
    if (currentStep === totalSteps - 1) {
        nextBtn.innerHTML = 'Complete <i class="fas fa-check ms-1"></i>';
        nextBtn.classList.add('btn-success');
        nextBtn.classList.remove('btn-primary');
        nextBtn.onclick = completeSession;
    } else {
        nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right ms-1"></i>';
        nextBtn.classList.add('btn-primary');
        nextBtn.classList.remove('btn-success');
        nextBtn.onclick = nextStep;
    }
}

function updateStepDots() {
    const dots = document.querySelectorAll('.step-dot');
    dots.forEach((dot, index) => {
        dot.classList.remove('active', 'completed');
        if (index === currentStep) {
            dot.classList.add('active');
        } else if (index < currentStep) {
            dot.classList.add('completed');
        }
    });
}

// Utility functions
function toggleAnswer(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = element.style.display === 'none' ? 'block' : 'none';
    }
}

function revealAnswer(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = 'block';
        event.target.style.display = 'none';
    }
}

function completeSession() {
    const slider = document.getElementById('confidenceSlider');
    const confidence = slider ? slider.value : 3;
    
    alert(`Session completed! Confidence level: ${confidence}/5`);
    // TODO: Save completion data via AJAX
    window.location.href = "{% url 'flashcards:pdf_focus_blocks' pdf_document.id %}";
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeStepper();
    
    // Confidence slider
    const slider = document.getElementById('confidenceSlider');
    const valueDisplay = document.getElementById('confidenceValue');
    
    if (slider && valueDisplay) {
        slider.addEventListener('input', function() {
            valueDisplay.textContent = this.value;
        });
    }
    
    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowRight' || e.key === ' ') {
            e.preventDefault();
            nextStep();
        } else if (e.key === 'ArrowLeft') {
            e.preventDefault();
            previousStep();
        }
    });
});
</script>

<style>
/* Step indicator dots */
.step-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background-color: #dee2e6;
    display: inline-block;
    margin: 0 4px;
    cursor: pointer;
    transition: all 0.3s;
}

.step-dot.active {
    background-color: #0d6efd;
    transform: scale(1.2);
}

.step-dot.completed {
    background-color: #198754;
}

/* Enhanced backgrounds for teaching modes */
.bg-light-blue { 
    background-color: #e3f2fd !important; 
}

.bg-light-green { 
    background-color: #e8f5e8 !important; 
}

.bg-light-warning { 
    background-color: #fff3cd !important; 
}

/* Smooth transitions */
.study-step {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .step-dots {
        display: none;
    }
}
</style>
{% endblock %} 